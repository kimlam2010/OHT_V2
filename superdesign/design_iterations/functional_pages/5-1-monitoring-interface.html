<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHT-50 Monitoring Interface</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- OHT-50 Theme -->
    <link rel="stylesheet" href="../../themes/theme_oht50_unified.css">
    <link rel="stylesheet" href="../../themes/theme_components.css">
    
    <style>
        /* Monitoring Interface specific styles */
        /* Top Navigation (from foundation) */
        .top-navigation {
            position: fixed;
            top: 0; left: 0; right: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-primary);
            border-bottom: var(--border-width-1) solid var(--border-color-light);
            box-shadow: var(--shadow-sm);
            z-index: var(--z-sticky);
        }
        .nav-brand { display:flex; align-items:center; gap: var(--space-sm); font-family: var(--font-display); font-size: var(--text-xl); font-weight: var(--font-bold); color: var(--primary-orange); }
        .nav-menu { display:flex; align-items:center; gap: var(--space-lg); }
        .nav-item { display:flex; align-items:center; gap: var(--space-xs); padding: var(--space-sm) var(--space-md); color: var(--industrial-gray-700); text-decoration:none; border-radius: var(--radius-md); transition: all var(--transition-fast); font-weight: var(--font-medium); }
        .nav-item:hover { background: var(--industrial-gray-100); color: var(--primary-orange); }
        .nav-item.active { background: var(--primary-orange); color: #fff; }
        .nav-actions { display:flex; align-items:center; gap: var(--space-sm); }
        .nav-btn { display:flex; align-items:center; justify-content:center; width:40px; height:40px; background: var(--bg-secondary); border: var(--border-width-1) solid var(--border-color-light); border-radius: var(--radius-md); color: var(--industrial-gray-600); transition: all var(--transition-fast); }
        .nav-btn:hover { background: var(--primary-orange); color:#fff; border-color: var(--primary-orange); }
        .nav-emergency-controls { display:flex; align-items:center; gap: var(--space-sm); margin-left: var(--space-lg); }
        .btn-emergency-nav { display:flex; align-items:center; gap: var(--space-xs); padding: var(--space-sm) var(--space-md); background: var(--safety-red); color:#fff; border:none; border-radius: var(--radius-md); font-size: var(--text-sm); font-weight: var(--font-bold); cursor:pointer; transition: all var(--transition-fast); box-shadow: var(--shadow-sm); }
        .btn-emergency-nav:hover { background: var(--error-red-dark); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-nav { display:flex; align-items:center; gap: var(--space-xs); padding: var(--space-sm) var(--space-md); border: var(--border-width-1) solid var(--border-color-light); border-radius: var(--radius-md); font-size: var(--text-sm); font-weight: var(--font-medium); cursor:pointer; transition: all var(--transition-fast); }
        .btn-warning-nav { background: var(--warning-yellow); color: var(--industrial-gray-900); border-color: var(--warning-yellow); }
        .btn-warning-nav:hover { background: var(--warning-yellow-dark); color:#fff; }
        .btn-success-nav { background: var(--success-green); color:#fff; border-color: var(--success-green); }
        .btn-success-nav:hover { background: var(--success-green-dark); }

        /* No left sidebar per latest spec */
        .page-main { display:block; }
        @media (max-width: 1024px) { .nav-menu{ display:none; } }

        /* RS485 Module Grid Cards */
        .rs485-module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-md);
            margin-top: var(--space-md);
        }
        
        .module-card {
            background: var(--bg-primary);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            transition: all var(--transition-fast);
            cursor: pointer;
        }
        
        .module-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .module-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
        }
        
        .module-name {
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
            font-size: var(--text-base);
        }
        
        .module-address {
            font-family: var(--font-mono);
            color: var(--industrial-gray-600);
            font-size: var(--text-sm);
        }
        
        .module-status {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-bold);
            text-transform: uppercase;
        }
        
        .module-status.healthy { background: var(--success-green-light); color: var(--success-green-dark); }
        .module-status.warn { background: var(--warning-yellow-light); color: var(--warning-yellow-dark); }
        .module-status.error { background: var(--error-red-light); color: var(--error-red-dark); }
        .module-status.lost { background: var(--industrial-gray-200); color: var(--industrial-gray-600); }
        
        .module-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            background: var(--industrial-gray-100);
            color: var(--industrial-gray-700);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            margin-bottom: var(--space-sm);
        }
        
        .module-badge.mandatory { background: var(--primary-orange-light); color: var(--primary-orange-dark); }
        .module-badge.optional { background: var(--industrial-gray-100); color: var(--industrial-gray-600); }
        
        .module-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }
        
        .module-metric {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        
        .metric-label {
            font-size: var(--text-xs);
            color: var(--industrial-gray-600);
            font-weight: var(--font-medium);
        }
        
        .metric-value {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
        }

        /* RS485 Bus Health Panel */
        .rs485-bus-health {
            background: var(--bg-primary);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
        }
        
        .bus-health-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }
        
        .bus-health-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
        }
        
        .bus-health-status {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .bus-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 2s infinite;
        }
        
        .bus-status-indicator.warning { background: var(--warning-yellow); }
        .bus-status-indicator.error { background: var(--error-red); }
        .bus-status-indicator.offline { background: var(--industrial-gray-400); }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* WebSocket Status Indicator */
        .ws-connected {
            color: var(--success-green);
            animation: pulse 2s infinite;
        }
        
        .ws-disconnected {
            color: var(--industrial-gray-400);
        }
        
        .ws-error {
            color: var(--error-red);
        }
        
        .bus-actions {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        
        .btn-bus-action {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-bus-action:hover {
            background: var(--primary-orange-dark);
            transform: translateY(-1px);
        }
        
        .btn-bus-action.secondary {
            background: var(--industrial-gray-100);
            color: var(--industrial-gray-700);
            border: var(--border-width-1) solid var(--border-color-light);
        }
        
        .btn-bus-action.secondary:hover {
            background: var(--industrial-gray-200);
        }
        
        .btn-bus-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .bus-kpis-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .bus-kpi-card {
            background: var(--industrial-gray-50);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            text-align: center;
        }
        
        .bus-kpi-value {
            font-family: var(--font-mono);
            font-size: var(--text-xl);
            font-weight: var(--font-bold);
            color: var(--industrial-gray-900);
            margin-bottom: var(--space-xs);
        }
        
        .bus-kpi-label {
            font-size: var(--text-xs);
            color: var(--industrial-gray-600);
            font-weight: var(--font-medium);
            text-transform: uppercase;
        }
        
        /* Discovery Section */
        .discovery-section {
            background: var(--bg-primary);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }
        
        .discovery-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }
        
        .discovery-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
        }
        
        .discovery-progress {
            background: var(--industrial-gray-100);
            border-radius: var(--radius-full);
            height: 8px;
            overflow: hidden;
            margin-bottom: var(--space-md);
        }
        
        .discovery-progress-bar {
            height: 100%;
            background: var(--primary-orange);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .discovery-status {
            font-size: var(--text-sm);
            color: var(--industrial-gray-600);
            margin-bottom: var(--space-md);
        }
        
        .discovery-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-sm);
        }
        
        .discovery-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm);
            background: var(--industrial-gray-50);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
        }
        
        .discovery-item.found {
            background: var(--success-green-light);
            color: var(--success-green-dark);
        }
        
        .discovery-item.conflict {
            background: var(--error-red-light);
            color: var(--error-red-dark);
        }
        
        .discovery-item-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
                 .discovery-item-icon.found { background: var(--success-green); }
         .discovery-item-icon.conflict { background: var(--error-red); }

         /* Module Detail Modal */
         .module-detail-modal {
             position: fixed;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background: rgba(0, 0, 0, 0.5);
             display: none;
             align-items: center;
             justify-content: center;
             z-index: var(--z-modal);
         }
         
         .module-detail-modal[open] {
             display: flex;
         }
         
         .modal-content {
             background: var(--bg-primary);
             border-radius: var(--radius-lg);
             box-shadow: var(--shadow-xl);
             max-width: 800px;
             width: 90%;
             max-height: 90vh;
             overflow: hidden;
             display: flex;
             flex-direction: column;
         }
         
         .modal-header {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: var(--space-lg);
             border-bottom: var(--border-width-1) solid var(--border-color-light);
             background: var(--industrial-gray-50);
         }
         
         .modal-title {
             font-size: var(--text-xl);
             font-weight: var(--font-bold);
             color: var(--industrial-gray-900);
         }
         
         .modal-close {
             background: none;
             border: none;
             color: var(--industrial-gray-600);
             cursor: pointer;
             padding: var(--space-sm);
             border-radius: var(--radius-md);
             transition: all var(--transition-fast);
         }
         
         .modal-close:hover {
             background: var(--industrial-gray-100);
             color: var(--industrial-gray-900);
         }
         
         .modal-tabs {
             display: flex;
             border-bottom: var(--border-width-1) solid var(--border-color-light);
             background: var(--bg-primary);
         }
         
         .modal-tab {
             padding: var(--space-md) var(--space-lg);
             background: none;
             border: none;
             color: var(--industrial-gray-600);
             cursor: pointer;
             font-weight: var(--font-medium);
             border-bottom: 2px solid transparent;
             transition: all var(--transition-fast);
         }
         
         .modal-tab.active {
             color: var(--primary-orange);
             border-bottom-color: var(--primary-orange);
             background: var(--primary-orange-light);
         }
         
         .modal-tab:hover:not(.active) {
             background: var(--industrial-gray-50);
             color: var(--industrial-gray-900);
         }
         
         .modal-body {
             flex: 1;
             overflow-y: auto;
             padding: var(--space-lg);
         }
         
         .tab-content {
             display: none;
         }
         
         .tab-content.active {
             display: block;
         }
         
         .module-overview {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: var(--space-lg);
         }
         
         .overview-section {
             background: var(--industrial-gray-50);
             border-radius: var(--radius-md);
             padding: var(--space-md);
         }
         
         .overview-title {
             font-size: var(--text-sm);
             font-weight: var(--font-semibold);
             color: var(--industrial-gray-700);
             margin-bottom: var(--space-sm);
             text-transform: uppercase;
         }
         
         .overview-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: var(--space-xs) 0;
             border-bottom: 1px solid var(--border-color-light);
         }
         
         .overview-item:last-child {
             border-bottom: none;
         }
         
         .overview-label {
             font-size: var(--text-sm);
             color: var(--industrial-gray-600);
         }
         
         .overview-value {
             font-family: var(--font-mono);
             font-size: var(--text-sm);
             font-weight: var(--font-semibold);
             color: var(--industrial-gray-900);
         }
         
         .module-actions {
             display: flex;
             gap: var(--space-sm);
             margin-top: var(--space-lg);
             padding-top: var(--space-lg);
             border-top: var(--border-width-1) solid var(--border-color-light);
         }
         
         .btn-module-action {
             display: inline-flex;
             align-items: center;
             gap: var(--space-xs);
             padding: var(--space-sm) var(--space-md);
             border: var(--border-width-1) solid var(--border-color-light);
             border-radius: var(--radius-md);
             background: var(--bg-primary);
             color: var(--industrial-gray-700);
             font-size: var(--text-sm);
             font-weight: var(--font-medium);
             cursor: pointer;
             transition: all var(--transition-fast);
         }
         
         .btn-module-action:hover {
             background: var(--industrial-gray-50);
             border-color: var(--industrial-gray-300);
         }
         
         .btn-module-action.danger {
             color: var(--error-red);
             border-color: var(--error-red-light);
         }
         
         .btn-module-action.danger:hover {
             background: var(--error-red-light);
         }
         
         .btn-module-action:disabled {
             opacity: 0.5;
             cursor: not-allowed;
         }
         
         .telemetry-chart {
             height: 200px;
             background: var(--industrial-gray-50);
             border: var(--border-width-1) solid var(--border-color-light);
             border-radius: var(--radius-md);
             display: flex;
             align-items: center;
             justify-content: center;
             color: var(--industrial-gray-500);
             font-size: var(--text-sm);
         }
         
        /* 🎯 Telemetry Table Styles - Modbus Tool Style */
        .telemetry-table-container {
            background: var(--bg-primary);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: var(--space-lg);
        }

        .telemetry-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--industrial-gray-50);
            border-bottom: var(--border-width-1) solid var(--border-color-light);
        }

        .telemetry-table-title {
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .telemetry-table-controls {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }

        .telemetry-search {
            padding: var(--space-xs) var(--space-sm);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
            width: 200px;
        }

        .telemetry-filter {
            padding: var(--space-xs) var(--space-sm);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-sm);
            font-size: var(--text-sm);
            background: var(--bg-primary);
        }

        .telemetry-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', 'Consolas', 'Monaco', monospace;
            font-size: var(--text-sm);
        }

        .telemetry-table th {
            background: var(--industrial-gray-100);
            padding: var(--space-sm) var(--space-md);
            text-align: left;
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
            border-bottom: var(--border-width-1) solid var(--border-color-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .telemetry-table td {
            padding: var(--space-sm) var(--space-md);
            border-bottom: var(--border-width-1) solid var(--border-color-light);
            color: var(--industrial-gray-800);
        }

        .telemetry-table tr:hover {
            background: var(--primary-orange-light);
        }

        .telemetry-table .address-cell {
            font-weight: var(--font-medium);
            color: var(--primary-orange);
            font-family: 'JetBrains Mono', monospace;
        }

        .telemetry-table .value-cell {
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
            font-family: 'JetBrains Mono', monospace;
            position: relative;
        }

        .telemetry-table .value-cell.updated {
            animation: valueFlash 0.8s ease-out;
            background: var(--status-warning-light);
        }

        @keyframes valueFlash {
            0% { background: var(--status-warning); }
            100% { background: transparent; }
        }

        .telemetry-table .status-cell {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .telemetry-table .mode-cell {
            font-family: 'JetBrains Mono', monospace;
            font-weight: var(--font-medium);
        }

        .telemetry-table .mode-cell.rw {
            color: var(--status-success);
        }

        .telemetry-table .mode-cell.r {
            color: var(--industrial-gray-600);
        }

        .telemetry-table .writable-input {
            background: var(--bg-primary);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-xs);
            padding: var(--space-xs);
            font-family: 'JetBrains Mono', monospace;
            font-size: var(--text-sm);
            width: 80px;
        }

        .telemetry-table .writable-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 2px var(--primary-orange-light);
        }

        .telemetry-table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--industrial-gray-50);
            border-top: var(--border-width-1) solid var(--border-color-light);
            font-size: var(--text-sm);
            color: var(--industrial-gray-600);
        }

        .telemetry-export-btn {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: all var(--transition-fast);
        }

        .telemetry-export-btn:hover {
            background: var(--primary-orange-dark);
            transform: translateY(-1px);
        }

        /* 📱 Responsive Design for Mobile */
        @media (max-width: 768px) {
            .telemetry-table-container {
                overflow-x: auto;
            }

            .telemetry-table {
                min-width: 600px;
            }

            .telemetry-search {
                width: 120px;
            }

            .telemetry-table-controls {
                flex-direction: column;
                gap: var(--space-xs);
            }
        }
         
         .alerts-list {
             max-height: 300px;
             overflow-y: auto;
         }
         
         .alert-item-small {
             display: flex;
             align-items: center;
             gap: var(--space-sm);
             padding: var(--space-sm);
             margin-bottom: var(--space-xs);
             background: var(--industrial-gray-50);
             border-radius: var(--radius-sm);
             border-left: 3px solid var(--industrial-gray-300);
         }
         
         .alert-item-small.warning {
             background: var(--warning-yellow-light);
             border-left-color: var(--warning-yellow);
         }
         
         .alert-item-small.error {
             background: var(--error-red-light);
             border-left-color: var(--error-red);
         }
         
         .logs-list {
             max-height: 300px;
             overflow-y: auto;
             font-family: var(--font-mono);
             font-size: var(--text-xs);
         }
         
         .log-item {
             padding: var(--space-xs) var(--space-sm);
             border-bottom: 1px solid var(--border-color-light);
         }
         
         .log-item:last-child {
             border-bottom: none;
         }
         
         .log-timestamp-small {
             color: var(--industrial-gray-500);
             margin-right: var(--space-sm);
         }
         
         .log-level-small {
             font-weight: var(--font-semibold);
             margin-right: var(--space-sm);
         }
         
         .log-level-small.info { color: var(--info-blue); }
         .log-level-small.warning { color: var(--warning-yellow); }
         .log-level-small.error { color: var(--error-red); }
         .log-level-small.success { color: var(--success-green); }

         /* Alert Filter Styles */
         .alerts-filter-container {
             display: flex;
             gap: var(--space-sm);
             align-items: center;
         }
         
         .module-filter-select,
         .severity-filter-select {
             padding: var(--space-xs) var(--space-sm);
             border: var(--border-width-1) solid var(--border-color-light);
             border-radius: var(--radius-md);
             background: var(--bg-primary);
             color: var(--industrial-gray-700);
             font-size: var(--text-sm);
             font-weight: var(--font-medium);
             cursor: pointer;
             transition: all var(--transition-fast);
         }
         
         .module-filter-select:hover,
         .severity-filter-select:hover {
             border-color: var(--primary-orange);
         }
         
         .module-filter-select:focus,
         .severity-filter-select:focus {
             outline: none;
             border-color: var(--primary-orange);
             box-shadow: 0 0 0 2px var(--primary-orange-light);
         }
         
         .alert-item {
             position: relative;
         }
         
         .alert-module-badge {
             position: absolute;
             top: var(--space-sm);
             right: var(--space-sm);
             padding: var(--space-xs) var(--space-sm);
             background: var(--industrial-gray-100);
             color: var(--industrial-gray-700);
             border-radius: var(--radius-sm);
             font-size: var(--text-xs);
             font-weight: var(--font-medium);
             font-family: var(--font-mono);
         }
         
         .alert-item.hidden {
             display: none;
         }

         .monitoring-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--space-lg);
            height: 100%;
            padding: var(--space-lg);
        }
        
        .telemetry-card {
            background: var(--bg-primary);
            border: 1px solid var(--industrial-gray-300);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .telemetry-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .metric-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
            padding: var(--space-sm);
            background: var(--industrial-gray-50);
            border-radius: var(--radius-md);
        }
        
        .metric-value {
            font-family: var(--font-mono);
            font-size: var(--text-xl);
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
        }
        
        .metric-label {
            font-size: var(--text-sm);
            color: var(--industrial-gray-600);
            font-weight: var(--font-medium);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }
        
        .status-healthy { background: var(--success-green-light); color: var(--success-green-dark); }
        .status-warning { background: var(--warning-yellow-light); color: var(--warning-yellow-dark); }
        .status-critical { background: var(--error-red-light); color: var(--error-red-dark); }
        .status-offline { background: var(--industrial-gray-200); color: var(--industrial-gray-600); }
        
        .chart-container {
            background: var(--bg-primary);
            border: 1px solid var(--industrial-gray-300);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .chart-placeholder {
            height: 200px;
            background: var(--industrial-gray-50);
            border: 2px dashed var(--industrial-gray-300);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--industrial-gray-500);
            font-size: var(--text-sm);
        }
        
        .alert-panel {
            background: var(--bg-primary);
            border: 1px solid var(--industrial-gray-300);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-sm);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            border-radius: var(--radius-md);
            border-left: 4px solid;
        }
        
        .alert-critical { background: var(--error-red-light); border-left-color: var(--error-red); }
        .alert-warning { background: var(--warning-yellow-light); border-left-color: var(--warning-yellow); }
        .alert-info { background: var(--info-blue-light); border-left-color: var(--info-blue); }
        .alert-success { background: var(--success-green-light); border-left-color: var(--success-green); }
        
        .alert-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: var(--font-semibold);
            margin-bottom: var(--space-xs);
        }
        
        .alert-message {
            font-size: var(--text-sm);
            color: var(--industrial-gray-600);
        }
        
        .alert-time {
            font-size: var(--text-xs);
            color: var(--industrial-gray-500);
            font-family: var(--font-mono);
        }
        
        .performance-gauge {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }
        
        .gauge-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                var(--success-green) 0deg,
                var(--success-green) calc(var(--percentage) * 3.6deg),
                var(--industrial-gray-200) calc(var(--percentage) * 3.6deg),
                var(--industrial-gray-200) 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gauge-center {
            width: 60px;
            height: 60px;
            background: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-mono);
            font-weight: var(--font-semibold);
            font-size: var(--text-lg);
        }
        
        .log-entries {
            background: var(--industrial-gray-900);
            color: var(--industrial-gray-100);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: var(--space-xs);
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
        }
        
        .log-info { background: rgba(59, 130, 246, 0.1); }
        .log-warning { background: rgba(245, 158, 11, 0.1); }
        .log-error { background: rgba(239, 68, 68, 0.1); }
        .log-success { background: rgba(34, 197, 94, 0.1); }
        
        .log-timestamp {
            color: var(--industrial-gray-400);
            margin-right: var(--space-sm);
        }
        
        .log-level {
            font-weight: var(--font-semibold);
            margin-right: var(--space-sm);
        }
        
        .log-info .log-level { color: var(--info-blue); }
        .log-warning .log-level { color: var(--warning-yellow); }
        .log-error .log-level { color: var(--error-red); }
        .log-success .log-level { color: var(--success-green); }
        
        /* Responsive Design */
        @media (max-width: 1536px) {
            .monitoring-grid {
                gap: var(--space-md);
                padding: var(--space-md);
            }
        }
        
        @media (max-width: 1280px) {
            .monitoring-grid {
                gap: var(--space-sm);
                padding: var(--space-sm);
            }
        }
        
        @media (max-width: 1024px) {
            .monitoring-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: var(--space-md);
                padding: var(--space-md);
            }
        }
        
        @media (max-width: 768px) {
            .monitoring-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: var(--space-sm);
                padding: var(--space-sm);
            }
            
            .telemetry-card {
                padding: var(--space-md);
            }
            
            .metric-value {
                font-size: var(--text-lg);
            }
        }
        
        @media (max-width: 640px) {
            .monitoring-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-xs);
                padding: var(--space-xs);
            }
            
            .telemetry-card {
                padding: var(--space-sm);
            }
            
            .metric-value {
                font-size: var(--text-base);
            }
        }

        /* Tab Navigation System - Option C */
        .tab-navigation {
            display: flex;
            background: var(--bg-primary);
            border-bottom: var(--border-width-1) solid var(--border-color-light);
            margin-bottom: var(--space-lg);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tab-navigation::-webkit-scrollbar {
            display: none;
        }
        
        .tab-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-md) var(--space-lg);
            background: none;
            border: none;
            color: var(--industrial-gray-600);
            cursor: pointer;
            font-weight: var(--font-medium);
            font-size: var(--text-sm);
            border-bottom: 2px solid transparent;
            transition: all var(--transition-fast);
            white-space: nowrap;
            min-width: 120px;
            justify-content: center;
        }
        
        .tab-item:hover {
            background: var(--industrial-gray-50);
            color: var(--industrial-gray-900);
        }
        
        .tab-item.active {
            color: var(--primary-orange);
            border-bottom-color: var(--primary-orange);
            background: var(--primary-orange-light);
        }
        
        .tab-item .tab-icon {
            width: 16px;
            height: 16px;
        }
        
        .tab-content {
            display: none !important;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block !important;
        }
        
        /* 🎯 Ensure modal tab-content works properly */
        #overview-tab.tab-content.active,
        #telemetry-tab.tab-content.active,
        #alerts-tab.tab-content.active,
        #logs-tab.tab-content.active {
            display: block !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* RS485 Modules Tab Specific Styles */
        .rs485-tab-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: var(--space-lg);
            height: calc(100vh - 200px);
        }
        
        .rs485-main-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }
        
        .rs485-detail-panel {
            background: var(--bg-primary);
            border: var(--border-width-1) solid var(--border-color-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            overflow-y: auto;
            height: 100%;
        }
        
        .rs485-detail-panel.hidden {
            display: none;
        }
        
        .rs485-detail-panel .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: var(--border-width-1) solid var(--border-color-light);
        }
        
        .rs485-detail-panel .detail-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
        }
        
        .rs485-detail-panel .detail-close {
            background: none;
            border: none;
            color: var(--industrial-gray-400);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }
        
        .rs485-detail-panel .detail-close:hover {
            background: var(--industrial-gray-100);
            color: var(--industrial-gray-900);
        }
        
        .rs485-detail-panel .detail-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }
        
        .rs485-detail-panel .detail-section {
            background: var(--industrial-gray-50);
            border-radius: var(--radius-md);
            padding: var(--space-md);
        }
        
        .rs485-detail-panel .detail-section-title {
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-700);
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
        }
        
        .rs485-detail-panel .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-xs) 0;
            border-bottom: 1px solid var(--border-color-light);
        }
        
        .rs485-detail-panel .detail-item:last-child {
            border-bottom: none;
        }
        
        .rs485-detail-panel .detail-label {
            font-size: var(--text-sm);
            color: var(--industrial-gray-600);
        }
        
        .rs485-detail-panel .detail-value {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            font-weight: var(--font-semibold);
            color: var(--industrial-gray-900);
        }
        
        .rs485-detail-panel .detail-controls {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }
        
        .rs485-detail-panel .btn-detail-action {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            background: var(--primary-orange);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .rs485-detail-panel .btn-detail-action:hover {
            background: var(--primary-orange-dark);
            transform: translateY(-1px);
        }
        
        .rs485-detail-panel .btn-detail-action.danger {
            background: var(--safety-red);
        }
        
        .rs485-detail-panel .btn-detail-action.danger:hover {
            background: var(--error-red-dark);
        }
        
        /* Responsive for RS485 Tab */
        @media (max-width: 1200px) {
            .rs485-tab-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .rs485-detail-panel {
                height: auto;
                max-height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .tab-navigation {
                margin-bottom: var(--space-md);
            }
            
            .tab-item {
                padding: var(--space-sm) var(--space-md);
                min-width: 100px;
                font-size: var(--text-xs);
            }
            
            .rs485-tab-content {
                gap: var(--space-md);
            }
        }
    </style>
</head>
<body>
    <!-- Skip Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Page Container -->
    <div class="page-container">
        <!-- Top Navigation Bar (standard) -->
        <nav class="top-navigation" role="navigation" aria-label="Main navigation">
            <div class="nav-brand">
                <i data-lucide="activity" class="w-6 h-6" aria-hidden="true"></i>
                <span>OHT-50</span>
            </div>
            <div class="nav-emergency-controls">
                <button class="btn-emergency-nav" id="emergency-stop" aria-label="Emergency Stop - Press to stop all operations immediately">
                    <i data-lucide="square" class="w-4 h-4" aria-hidden="true"></i>
                    E-STOP
                </button>
                <button class="btn-nav btn-warning-nav" id="pause-system" aria-label="Pause System">
                    <i data-lucide="pause" class="w-4 h-4" aria-hidden="true"></i>
                    Pause
                </button>
                <button class="btn-nav btn-success-nav" id="reset-system" aria-label="Reset System">
                    <i data-lucide="refresh-cw" class="w-4 h-4" aria-hidden="true"></i>
                    Reset
                </button>
            </div>
            <div class="nav-menu">
                <a href="../core_pages/2-1-dashboard-main.html" class="nav-item">
                    <i data-lucide="layout-dashboard" class="w-4 h-4" aria-hidden="true"></i>
                    Dashboard
                </a>
                <a href="../core_pages/3-1-control-panel.html" class="nav-item">
                    <i data-lucide="gamepad-2" class="w-4 h-4" aria-hidden="true"></i>
                    Control Panel
                </a>
                <a href="../core_pages/4-1-map-interface.html" class="nav-item">
                    <i data-lucide="map" class="w-4 h-4" aria-hidden="true"></i>
                    Map & Navigation
                </a>
                <a href="../functional_pages/5-1-monitoring-interface.html" class="nav-item active" aria-current="page">
                    <i data-lucide="monitor" class="w-4 h-4" aria-hidden="true"></i>
                    Monitoring
                </a>
                <a href="../functional_pages/6-1-configuration.html" class="nav-item">
                    <i data-lucide="settings" class="w-4 h-4" aria-hidden="true"></i>
                    Configuration
                </a>
                <a href="../functional_pages/7-1-reports.html" class="nav-item">
                    <i data-lucide="file-text" class="w-4 h-4" aria-hidden="true"></i>
                    Reports
                </a>
            </div>
            <div class="nav-actions">
                <button class="nav-btn" id="refresh-data" aria-label="Refresh monitoring data">
                    <i data-lucide="refresh-cw" class="w-5 h-5" aria-hidden="true"></i>
                </button>
                <button class="nav-btn" aria-label="Notifications">
                    <i data-lucide="bell" class="w-5 h-5" aria-hidden="true"></i>
                </button>
                <button class="nav-btn" aria-label="User menu">
                    <i data-lucide="user" class="w-5 h-5" aria-hidden="true"></i>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="page-main" style="padding-top:80px;">
            <!-- Breadcrumbs -->
            <nav class="breadcrumb-nav" aria-label="Breadcrumb" style="padding: 0 var(--space-lg); margin-top: var(--space-lg);">
                <a href="../core_pages/2-1-dashboard-main.html" class="breadcrumb-item">Dashboard</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item active">Monitoring</span>
            </nav>

            <!-- Tab Navigation System - Option C -->
            <div class="tab-navigation" role="tablist" aria-label="Monitoring tabs">
                <button class="tab-item active" role="tab" aria-selected="true" aria-controls="tab-overview" id="tab-overview-btn" onclick="switchTab('tab-overview')">
                    <i data-lucide="activity" class="tab-icon" aria-hidden="true"></i>
                    System Overview
                </button>
                <button class="tab-item" role="tab" aria-selected="false" aria-controls="tab-rs485" id="tab-rs485-btn" onclick="switchTab('tab-rs485')">
                    <i data-lucide="network" class="tab-icon" aria-hidden="true"></i>
                    RS485 Modules
                </button>
                <button class="tab-item" role="tab" aria-selected="false" aria-controls="tab-alerts" id="tab-alerts-btn" onclick="switchTab('tab-alerts')">
                    <i data-lucide="alert-triangle" class="tab-icon" aria-hidden="true"></i>
                    Alerts & Events
                </button>
                <button class="tab-item" role="tab" aria-selected="false" aria-controls="tab-logs" id="tab-logs-btn" onclick="switchTab('tab-logs')">
                    <i data-lucide="file-text" class="tab-icon" aria-hidden="true"></i>
                    System Logs
                </button>
                <button class="tab-item" role="tab" aria-selected="false" aria-controls="tab-analytics" id="tab-analytics-btn" onclick="switchTab('tab-analytics')">
                    <i data-lucide="bar-chart-3" class="tab-icon" aria-hidden="true"></i>
                    Analytics
                </button>
            </div>

            <!-- Tab Content: System Overview -->
            <div id="tab-overview" class="tab-content active" role="tabpanel" aria-labelledby="tab-overview-btn">
                <div class="monitoring-grid">
                <!-- System Health Overview -->
                <section class="col-span-3 telemetry-card">
                    <h3 class="text-lg font-semibold mb-4">System Health</h3>
                    <div class="space-y-4">
                        <div class="metric-display">
                            <span class="metric-label">Overall Status</span>
                            <span class="status-indicator status-healthy" id="overall-status">HEALTHY</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">Uptime</span>
                            <span class="metric-value" id="uptime">2d 14h 32m</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">Last Restart</span>
                            <span class="metric-value" id="last-restart">2025-02-16 08:30</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">System Load</span>
                            <span class="metric-value" id="system-load">0.45</span>
                        </div>
                    </div>
                </section>

                <!-- Performance Metrics -->
                <section class="col-span-3 telemetry-card">
                    <h3 class="text-lg font-semibold mb-4">Performance</h3>
                    <div class="space-y-4">
                        <div class="metric-display">
                            <span class="metric-label">CPU Usage</span>
                            <div class="performance-gauge">
                                <div class="gauge-circle" style="--percentage: 45;">
                                    <div class="gauge-center">45%</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">Memory Usage</span>
                            <span class="metric-value" id="memory-usage">67%</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">Disk Usage</span>
                            <span class="metric-value" id="disk-usage">23%</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">Network I/O</span>
                            <span class="metric-value" id="network-io">2.4 MB/s</span>
                        </div>
                    </div>
                </section>

                <!-- Communication Status -->
                <section class="col-span-3 telemetry-card">
                    <h3 class="text-lg font-semibold mb-4">Communication</h3>
                    <div class="space-y-4">
                        <div class="metric-display">
                            <span class="metric-label">Center Connection</span>
                            <span class="status-indicator status-healthy" id="center-connection">CONNECTED</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">RS485 Status</span>
                            <span class="status-indicator status-healthy" id="rs485-status">ACTIVE</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">WiFi Signal</span>
                            <span class="metric-value" id="wifi-signal">-45 dBm</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">Latency</span>
                            <span class="metric-value" id="latency">12ms</span>
                        </div>
                    </div>
                </section>

                <!-- Safety Status -->
                <section class="col-span-3 telemetry-card">
                    <h3 class="text-lg font-semibold mb-4">Safety Status</h3>
                    <div class="space-y-4">
                        <div class="metric-display">
                            <span class="metric-label">E-Stop Status</span>
                            <span class="status-indicator status-healthy" id="estop-status">READY</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">Safety Zone</span>
                            <span class="status-indicator status-healthy" id="safety-zone">CLEAR</span>
                        </div>
                        <div class="metric-display">
                            <span class="metric-label">Emergency Contact</span>
                            <span class="metric-value" id="emergency-contact">+84 123 456 789</span>
                        </div>
                    </div>
                </section>

                <!-- RS485 Bus Health Panel -->
                <section class="col-span-4 telemetry-card" aria-label="RS485 bus health">
                    <div id="rs485-bus-health" class="rs485-bus-health">
                        <div class="bus-health-header">
                            <h3 class="bus-health-title">RS485 Bus Health</h3>
                            <div class="bus-health-status">
                                <div class="bus-status-indicator" id="bus-status-indicator"></div>
                                <span class="text-sm font-medium" id="bus-status-text">Online</span>
                            </div>
                        </div>
                        
                        <div class="bus-actions">
                            <button id="btn-scan" class="btn-bus-action">
                                <i data-lucide="search" class="w-4 h-4" aria-hidden="true"></i>
                                Scan Now
                            </button>
                            <button id="btn-restart" class="btn-bus-action secondary">
                                <i data-lucide="refresh-cw" class="w-4 h-4" aria-hidden="true"></i>
                                Restart Bus
                            </button>
                        </div>
                        
                        <div id="bus-kpis" class="bus-kpis-grid">
                            <!-- Bus KPIs will be populated by JavaScript -->
                        </div>
                        
                        <!-- Discovery Section -->
                        <div id="discovery-status" class="discovery-section">
                            <div class="discovery-header">
                                <h4 class="discovery-title">Module Discovery</h4>
                            </div>
                            
                            <div class="discovery-progress">
                                <div class="discovery-progress-bar" id="disc-progress-bar"></div>
                            </div>
                            
                            <div class="discovery-status" id="disc-progress">Ready to scan</div>
                            
                            <div class="discovery-results" id="disc-collisions">
                                <!-- Discovery results will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- RS485 Modules Grid -->
                <section class="col-span-8 telemetry-card" aria-label="RS485 modules">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">RS485 Modules</h3>
                        <small class="text-industrial-gray-600">0x01 – 0x0F</small>
                    </div>
                    <div id="rs485-module-grid" class="rs485-module-grid" role="grid" aria-label="RS485 Module Grid"></div>
                </section>

                <aside class="col-span-4 space-y-4" aria-label="Bus health and discovery">
                    <section id="rs485-bus-health" class="telemetry-card" aria-labelledby="bus-health-title">
                        <h4 id="bus-health-title" class="text-base font-semibold mb-3">RS485 Bus Health</h4>
                        <div id="bus-kpis" class="grid grid-cols-2 gap-3" aria-live="polite"></div>
                        <div class="flex gap-2 mt-3">
                            <button class="btn btn-secondary" id="btn-scan" title="Scan RS485 bus">Scan Now</button>
                            <button class="btn btn-secondary" id="btn-restart" title="Requires Operator+">Restart Bus</button>
                        </div>
                    </section>

                    <section id="discovery-status" class="telemetry-card" aria-labelledby="disc-title">
                        <h4 id="disc-title" class="text-base font-semibold mb-3">Discovery</h4>
                        <div id="disc-progress" class="text-sm text-industrial-gray-700">Idle</div>
                        <ul id="disc-collisions" class="list-disc pl-5 mt-2 text-sm"></ul>
                    </section>
                </aside>

                <!-- Real-time Charts -->
                <section class="col-span-6 chart-container">
                    <h3 class="text-lg font-semibold mb-4">Performance Trends</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="chart-placeholder">
                            <div class="text-center">
                                <i data-lucide="trending-up" class="w-8 h-8 mx-auto mb-2 text-industrial-gray-400"></i>
                                <p>CPU Usage Trend</p>
                                <p class="text-xs">Chart.js integration</p>
                            </div>
                        </div>
                        <div class="chart-placeholder">
                            <div class="text-center">
                                <i data-lucide="activity" class="w-8 h-8 mx-auto mb-2 text-industrial-gray-400"></i>
                                <p>Memory Usage Trend</p>
                                <p class="text-xs">Chart.js integration</p>
                            </div>
                        </div>
                    </div>
                </section>

                                 <!-- Alert Management -->
                 <section class="col-span-6 alert-panel">
                     <div class="flex items-center justify-between mb-4">
                         <h3 class="text-lg font-semibold">Active Alerts</h3>
                         <div class="flex items-center gap-3">
                             <div id="alerts-filter-by-module" class="alerts-filter-container" aria-label="Filter alerts by module">
                                 <select id="module-filter-select" class="module-filter-select" aria-label="Filter by module">
                                     <option value="all">All Modules</option>
                                     <option value="0x01">Power (0x01)</option>
                                     <option value="0x02">Safety (0x02)</option>
                                     <option value="0x03">Travel (0x03)</option>
                                     <option value="0x04">Dock & Location (0x04)</option>
                                     <option value="0x05">Master (0x05)</option>
                                     <option value="0x06">Lifter (0x06)</option>
                                     <option value="0x07">Cargo (0x07)</option>
                                 </select>
                                 <select id="severity-filter-select" class="severity-filter-select" aria-label="Filter by severity">
                                     <option value="all">All Severities</option>
                                     <option value="critical">Critical</option>
                                     <option value="warning">Warning</option>
                                     <option value="info">Info</option>
                                     <option value="success">Success</option>
                                 </select>
                             </div>
                             <button class="btn btn-secondary btn-sm" id="clear-alerts" aria-label="Clear all alerts">
                                 <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                                 Clear All
                             </button>
                         </div>
                     </div>
                                         <div id="alerts-container" class="space-y-2">
                         <div class="alert-item alert-info" data-module="0x05" data-severity="info">
                             <i data-lucide="info" class="alert-icon text-info-blue" aria-hidden="true"></i>
                             <div class="alert-content">
                                 <div class="alert-title">System Update Available</div>
                                 <div class="alert-message">New firmware version v2.1.0 is ready for installation</div>
                                 <div class="alert-time">2 minutes ago</div>
                             </div>
                             <div class="alert-module-badge">Master (0x05)</div>
                             <button class="btn btn-secondary btn-sm" aria-label="Dismiss alert">
                                 <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                             </button>
                         </div>
                         <div class="alert-item alert-warning" data-module="0x02" data-severity="warning">
                             <i data-lucide="alert-triangle" class="alert-icon text-warning-yellow" aria-hidden="true"></i>
                             <div class="alert-content">
                                 <div class="alert-title">High Error Rate Detected</div>
                                 <div class="alert-message">Safety module error rate above 2% threshold</div>
                                 <div class="alert-time">5 minutes ago</div>
                             </div>
                             <div class="alert-module-badge">Safety (0x02)</div>
                             <button class="btn btn-secondary btn-sm" aria-label="Dismiss alert">
                                 <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                             </button>
                         </div>
                         <div class="alert-item alert-success" data-module="0x04" data-severity="success">
                             <i data-lucide="check-circle" class="alert-icon text-success-green" aria-hidden="true"></i>
                             <div class="alert-content">
                                 <div class="alert-title">Dock & Location Operational</div>
                                 <div class="alert-message">All positioning systems verified and operational</div>
                                 <div class="alert-time">10 minutes ago</div>
                             </div>
                             <div class="alert-module-badge">Dock & Location (0x04)</div>
                             <button class="btn btn-secondary btn-sm" aria-label="Dismiss alert">
                                 <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                             </button>
                         </div>
                         <div class="alert-item alert-critical" data-module="0x01" data-severity="critical">
                             <i data-lucide="alert-circle" class="alert-icon text-error-red" aria-hidden="true"></i>
                             <div class="alert-content">
                                 <div class="alert-title">Power Module Critical</div>
                                 <div class="alert-message">Battery level below 10% - immediate attention required</div>
                                 <div class="alert-time">1 minute ago</div>
                             </div>
                             <div class="alert-module-badge">Power (0x01)</div>
                             <button class="btn btn-secondary btn-sm" aria-label="Dismiss alert">
                                 <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                             </button>
                         </div>
                     </div>
                </section>

                <!-- System Logs -->
                <section class="col-span-12 chart-container">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">System Logs</h3>
                        <div class="flex items-center gap-2">
                            <select class="form-select" id="log-level-filter" aria-label="Filter log level">
                                <option value="all">All Levels</option>
                                <option value="info">Info</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                                <option value="success">Success</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" id="export-logs" aria-label="Export logs">
                                <i data-lucide="download" class="w-4 h-4" aria-hidden="true"></i>
                                Export
                            </button>
                        </div>
                    </div>
                    <div class="log-entries" id="log-entries">
                        <div class="log-entry log-info">
                            <span class="log-timestamp">14:32:15</span>
                            <span class="log-level">INFO</span>
                            <span>System monitoring started successfully</span>
                        </div>
                        <div class="log-entry log-success">
                            <span class="log-timestamp">14:32:10</span>
                            <span class="log-level">SUCCESS</span>
                            <span>All safety systems operational</span>
                        </div>
                        <div class="log-entry log-warning">
                            <span class="log-timestamp">14:31:45</span>
                            <span class="log-level">WARNING</span>
                            <span>Memory usage approaching threshold (78%)</span>
                        </div>
                        <div class="log-entry log-info">
                            <span class="log-timestamp">14:31:30</span>
                            <span class="log-level">INFO</span>
                            <span>Telemetry data updated</span>
                        </div>
                        <div class="log-entry log-error">
                            <span class="log-timestamp">14:30:15</span>
                            <span class="log-level">ERROR</span>
                            <span>Network connection timeout - retrying</span>
                        </div>
                    </div>
                </section>
            </div>
            </div>

            <!-- Tab Content: RS485 Modules -->
            <div id="tab-rs485" class="tab-content" role="tabpanel" aria-labelledby="tab-rs485-btn">
                <div class="rs485-tab-content">
                    <!-- Main Content Area -->
                    <div class="rs485-main-content">
                        <!-- Top Controls -->
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium">RS485 Bus Health:</span>
                                    <div class="bus-status-indicator" id="rs485-bus-status-indicator"></div>
                                    <span class="text-sm font-medium" id="rs485-bus-status-text">Online</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-industrial-gray-600">WebSocket:</span>
                                    <div id="rs485-ws-status" class="ws-disconnected" title="WebSocket status">
                                        <div class="w-2 h-2 rounded-full bg-current"></div>
                                    </div>
                                </div>
                                <button id="rs485-btn-scan" class="btn-bus-action">
                                    <i data-lucide="search" class="w-4 h-4" aria-hidden="true"></i>
                                    Scan Now
                                </button>
                                <button id="rs485-btn-restart" class="btn-bus-action secondary">
                                    <i data-lucide="refresh-cw" class="w-4 h-4" aria-hidden="true"></i>
                                    Restart Bus
                                </button>
                            </div>
                            <button id="rs485-btn-add-module" class="btn-bus-action">
                                <i data-lucide="plus" class="w-4 h-4" aria-hidden="true"></i>
                                Add Module
                            </button>
                        </div>

                        <!-- Module Grid -->
                        <div class="rs485-module-grid" id="rs485-module-grid">
                            <!-- Module cards will be dynamically generated -->
                        </div>
                    </div>

                    <!-- Detail Panel -->
                    <div id="rs485-detail-panel" class="rs485-detail-panel hidden">
                        <div class="detail-header">
                            <h3 class="detail-title" id="detail-module-title">Select a Module</h3>
                            <button class="detail-close" onclick="closeRs485Detail()" aria-label="Close detail panel">
                                <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="detail-content" id="detail-content">
                            <div class="detail-section">
                                <h4 class="detail-section-title">Module Status</h4>
                                <div class="detail-item">
                                    <span class="detail-label">Status:</span>
                                    <span class="detail-value" id="detail-status">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Last Seen:</span>
                                    <span class="detail-value" id="detail-last-seen">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Error Rate:</span>
                                    <span class="detail-value" id="detail-error-rate">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Response Time:</span>
                                    <span class="detail-value" id="detail-response-time">-</span>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4 class="detail-section-title">Real-time Values</h4>
                                <div class="detail-item">
                                    <span class="detail-label">Battery Level:</span>
                                    <span class="detail-value" id="detail-battery">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Voltage:</span>
                                    <span class="detail-value" id="detail-voltage">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Current:</span>
                                    <span class="detail-value" id="detail-current">-</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Temperature:</span>
                                    <span class="detail-value" id="detail-temperature">-</span>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4 class="detail-section-title">Module Controls</h4>
                                <div class="detail-controls">
                                    <button class="btn-detail-action" onclick="pingModule()">
                                        <i data-lucide="radio" class="w-3 h-3" aria-hidden="true"></i>
                                        Ping
                                    </button>
                                    <button class="btn-detail-action" onclick="resetModule()">
                                        <i data-lucide="refresh-cw" class="w-3 h-3" aria-hidden="true"></i>
                                        Reset
                                    </button>
                                    <button class="btn-detail-action" onclick="configureModule()">
                                        <i data-lucide="settings" class="w-3 h-3" aria-hidden="true"></i>
                                        Configure
                                    </button>
                                    <button class="btn-detail-action danger" onclick="quarantineModule()">
                                        <i data-lucide="shield-x" class="w-3 h-3" aria-hidden="true"></i>
                                        Quarantine
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Alerts & Events -->
            <div id="tab-alerts" class="tab-content" role="tabpanel" aria-labelledby="tab-alerts-btn">
                <div class="monitoring-grid">
                    <section class="col-span-12 alert-panel">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">Alert Management</h3>
                            <div class="flex items-center gap-3">
                                <div class="alerts-filter-container" aria-label="Filter alerts by module">
                                    <select class="module-filter-select" aria-label="Filter by module">
                                        <option value="all">All Modules</option>
                                        <option value="0x01">Power (0x01)</option>
                                        <option value="0x02">Safety (0x02)</option>
                                        <option value="0x03">Travel (0x03)</option>
                                        <option value="0x04">Dock & Location (0x04)</option>
                                        <option value="0x05">Master (0x05)</option>
                                        <option value="0x06">Lifter (0x06)</option>
                                        <option value="0x07">Cargo (0x07)</option>
                                    </select>
                                    <select class="severity-filter-select" aria-label="Filter by severity">
                                        <option value="all">All Severities</option>
                                        <option value="critical">Critical</option>
                                        <option value="warning">Warning</option>
                                        <option value="info">Info</option>
                                        <option value="success">Success</option>
                                    </select>
                                </div>
                                <button class="btn btn-secondary btn-sm" aria-label="Clear all alerts">
                                    <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                                    Clear All
                                </button>
                            </div>
                        </div>
                        <div id="alerts-container-enhanced" class="space-y-2">
                            <!-- Enhanced alerts will be populated here -->
                        </div>
                    </section>
                </div>
            </div>

            <!-- Tab Content: System Logs -->
            <div id="tab-logs" class="tab-content" role="tabpanel" aria-labelledby="tab-logs-btn">
                <div class="monitoring-grid">
                    <section class="col-span-12 chart-container">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">System Logs</h3>
                            <div class="flex items-center gap-2">
                                <select class="form-select" aria-label="Filter log level">
                                    <option value="all">All Levels</option>
                                    <option value="info">Info</option>
                                    <option value="warning">Warning</option>
                                    <option value="error">Error</option>
                                    <option value="success">Success</option>
                                </select>
                                <button class="btn btn-secondary btn-sm" aria-label="Export logs">
                                    <i data-lucide="download" class="w-4 h-4" aria-hidden="true"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        <div class="log-entries" id="log-entries-enhanced">
                            <!-- Enhanced logs will be populated here -->
                        </div>
                    </section>
                </div>
            </div>

            <!-- Tab Content: Analytics -->
            <div id="tab-analytics" class="tab-content" role="tabpanel" aria-labelledby="tab-analytics-btn">
                <div class="monitoring-grid">
                    <section class="col-span-12 chart-container">
                        <h3 class="text-lg font-semibold mb-4">Performance Analytics</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="chart-placeholder">
                                <div class="text-center">
                                    <i data-lucide="trending-up" class="w-8 h-8 mx-auto mb-2 text-industrial-gray-400"></i>
                                    <p>System Performance Trends</p>
                                    <p class="text-xs">Advanced analytics coming soon</p>
                                </div>
                            </div>
                            <div class="chart-placeholder">
                                <div class="text-center">
                                    <i data-lucide="bar-chart-3" class="w-8 h-8 mx-auto mb-2 text-industrial-gray-400"></i>
                                    <p>Module Health Analytics</p>
                                    <p class="text-xs">Advanced analytics coming soon</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="page-footer">
            <div class="flex items-center gap-4">
                <span class="text-sm text-industrial-gray-600">Last Update: <span id="last-update">2025-02-18 14:32:15</span></span>
                <span class="text-sm text-industrial-gray-600">Data Refresh: <span id="refresh-interval">5s</span></span>
            </div>
            <div class="flex items-center gap-4">
                <button class="btn btn-secondary btn-sm" id="pause-monitoring" aria-label="Pause monitoring">
                    <i data-lucide="pause" class="w-4 h-4" aria-hidden="true"></i>
                    Pause
                </button>
                <button class="btn btn-secondary btn-sm" id="fullscreen" aria-label="Fullscreen view">
                    <i data-lucide="maximize" class="w-4 h-4" aria-hidden="true"></i>
                    Fullscreen
                </button>
            </div>
                 </footer>
     </div>

     <!-- Module Detail Modal -->
     <div id="module-detail-modal" class="module-detail-modal">
         <div class="modal-content">
             <div class="modal-header">
                 <h2 class="modal-title" id="module-modal-title">Module Details</h2>
                 <button class="modal-close" onclick="closeModuleDetail()" aria-label="Close modal">
                     <i data-lucide="x" class="w-5 h-5" aria-hidden="true"></i>
                 </button>
             </div>
             
             <div class="modal-tabs">
                 <button class="modal-tab active" onclick="switchTab('overview')">Overview</button>
                 <button class="modal-tab" onclick="showTelemetryTab()" id="telemetry-tab-btn">Telemetry</button>
                 <button class="modal-tab" onclick="switchTab('alerts')">Alerts</button>
                 <button class="modal-tab" onclick="switchTab('logs')">Logs</button>
             </div>
             
             <div class="modal-body">
                 <!-- Overview Tab -->
                 <div id="overview-tab" class="tab-content active">
                     <div class="module-overview">
                         <div class="overview-section">
                             <h3 class="overview-title">Module Information</h3>
                             <div class="overview-item">
                                 <span class="overview-label">Module Name</span>
                                 <span class="overview-value" id="modal-module-name">-</span>
                             </div>
                             <div class="overview-item">
                                 <span class="overview-label">Address</span>
                                 <span class="overview-value" id="modal-module-addr">-</span>
                             </div>
                             <div class="overview-item">
                                 <span class="overview-label">Type</span>
                                 <span class="overview-value" id="modal-module-type">-</span>
                             </div>
                             <div class="overview-item">
                                 <span class="overview-label">FW Version</span>
                                 <span class="overview-value" id="modal-module-fw">-</span>
                             </div>
                         </div>
                         
                         <div class="overview-section">
                             <h3 class="overview-title">Status & Health</h3>
                             <div class="overview-item">
                                 <span class="overview-label">Status</span>
                                 <span class="overview-value" id="modal-module-status">-</span>
                             </div>
                             <div class="overview-item">
                                 <span class="overview-label">Last Seen</span>
                                 <span class="overview-value" id="modal-module-last-seen">-</span>
                             </div>
                             <div class="overview-item">
                                 <span class="overview-label">Error Rate</span>
                                 <span class="overview-value" id="modal-module-error-rate">-</span>
                             </div>
                             <div class="overview-item">
                                 <span class="overview-label">Response P95</span>
                                 <span class="overview-value" id="modal-module-response-p95">-</span>
                             </div>
                         </div>
                     </div>
                     
                     <div class="module-actions">
                         <button class="btn-module-action" onclick="pingModule()">
                             <i data-lucide="radio" class="w-4 h-4" aria-hidden="true"></i>
                             Ping Module
                         </button>
                         <button class="btn-module-action" onclick="retryModule()">
                             <i data-lucide="refresh-cw" class="w-4 h-4" aria-hidden="true"></i>
                             Retry Connection
                         </button>
                         <button class="btn-module-action danger" onclick="quarantineModule()">
                             <i data-lucide="shield-x" class="w-4 h-4" aria-hidden="true"></i>
                             Quarantine
                         </button>
                     </div>
                 </div>
                 
                 <!-- Telemetry Tab -->
                 <div id="telemetry-tab" class="tab-content">
                    <!-- 🎯 Telemetry Table Container -->
                    <div class="telemetry-table-container">
                        <!-- Table Header with Controls -->
                        <div class="telemetry-table-header">
                            <div class="telemetry-table-title">
                                <i data-lucide="database" class="w-5 h-5 text-primary-orange"></i>
                                <span>Modbus Registers - Power Module (0x02)</span>
                            </div>
                            <div class="telemetry-table-controls">
                                <input type="text" 
                                       class="telemetry-search" 
                                       placeholder="Search registers..." 
                                       id="telemetry-search"
                                       onkeyup="filterTelemetryTable()">
                                <select class="telemetry-filter" 
                                        id="telemetry-mode-filter" 
                                        onchange="filterTelemetryByMode()">
                                    <option value="all">All Modes</option>
                                    <option value="r">Read Only (R)</option>
                                    <option value="rw">Read/Write (RW)</option>
                                </select>
                         </div>
                     </div>
                     
                        <!-- Telemetry Table -->
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="telemetry-table" id="telemetry-registers-table">
                                <thead>
                                    <tr>
                                        <th>Address</th>
                                        <th>Parameter Name</th>
                                        <th>Value</th>
                                        <th>Unit</th>
                                        <th>Mode</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="telemetry-table-body">
                                    <!-- Power Module 0x02 Registers -->
                                    <tr data-address="0x0000" data-mode="r">
                                        <td class="address-cell">0x0000</td>
                                        <td>Battery Voltage</td>
                                        <td class="value-cell" data-register="battery_voltage">24.2</td>
                                        <td>V</td>
                                        <td class="mode-cell r">R</td>
                                        <td class="status-cell">🟢 Normal</td>
                                    </tr>
                                    <tr data-address="0x0001" data-mode="r">
                                        <td class="address-cell">0x0001</td>
                                        <td>Battery Current</td>
                                        <td class="value-cell" data-register="battery_current">2.1</td>
                                        <td>A</td>
                                        <td class="mode-cell r">R</td>
                                        <td class="status-cell">🟢 Normal</td>
                                    </tr>
                                    <tr data-address="0x0002" data-mode="r">
                                        <td class="address-cell">0x0002</td>
                                        <td>Battery SOC</td>
                                        <td class="value-cell" data-register="battery_soc">85.4</td>
                                        <td>%</td>
                                        <td class="mode-cell r">R</td>
                                        <td class="status-cell">🟢 Normal</td>
                                    </tr>
                                    <tr data-address="0x0003" data-mode="r">
                                        <td class="address-cell">0x0003</td>
                                        <td>Max Cell Voltage</td>
                                        <td class="value-cell" data-register="max_cell_voltage">3450</td>
                                        <td>mV</td>
                                        <td class="mode-cell r">R</td>
                                        <td class="status-cell">🟢 Normal</td>
                                    </tr>
                                    <tr data-address="0x0008" data-mode="r">
                                        <td class="address-cell">0x0008</td>
                                        <td>Temperature</td>
                                        <td class="value-cell" data-register="temperature">42</td>
                                        <td>°C</td>
                                        <td class="mode-cell r">R</td>
                                        <td class="status-cell">🟢 Normal</td>
                                    </tr>
                                    <tr data-address="0x003C" data-mode="rw">
                                        <td class="address-cell">0x003C</td>
                                        <td>Output ON/OFF</td>
                                        <td class="value-cell" data-register="output_enable">
                                            <input type="number" 
                                                   class="writable-input" 
                                                   value="1" 
                                                   min="0" 
                                                   max="1"
                                                   onchange="writeRegister('0x003C', this.value)">
                                        </td>
                                        <td>bool</td>
                                        <td class="mode-cell rw">RW</td>
                                        <td class="status-cell">🟢 Normal</td>
                                    </tr>
                                    <tr data-address="0x0040" data-mode="r">
                                        <td class="address-cell">0x0040</td>
                                        <td>12V Output Voltage</td>
                                        <td class="value-cell" data-register="output_12v_voltage">12.1</td>
                                        <td>V</td>
                                        <td class="mode-cell r">R</td>
                                        <td class="status-cell">🟢 Normal</td>
                                    </tr>
                                    <tr data-address="0x0049" data-mode="rw">
                                        <td class="address-cell">0x0049</td>
                                        <td>12V Relay</td>
                                        <td class="value-cell" data-register="relay_12v">
                                            <input type="number" 
                                                   class="writable-input" 
                                                   value="1" 
                                                   min="0" 
                                                   max="1"
                                                   onchange="writeRegister('0x0049', this.value)">
                                        </td>
                                        <td>bool</td>
                                        <td class="mode-cell rw">RW</td>
                                        <td class="status-cell">🟢 Normal</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Table Footer with Export and Stats -->
                        <div class="telemetry-table-footer">
                            <div>
                                <span id="telemetry-stats">8 registers total • 6 read-only • 2 writable</span>
                                <span style="margin-left: var(--space-md); color: var(--status-success);">
                                    <i data-lucide="wifi" class="w-4 h-4 inline"></i>
                                    Connected • Last update: <span id="last-update-time">2s ago</span>
                                </span>
                            </div>
                            <div style="display: flex; gap: var(--space-sm);">
                                <button class="telemetry-export-btn" onclick="exportTelemetryCSV()">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Export CSV
                         </button>
                                <button class="telemetry-export-btn" onclick="exportTelemetryExcel()" 
                                        style="background: var(--status-success);">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                    Export Excel
                         </button>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Section (Optional - can be toggled) -->
                    <div class="telemetry-chart" style="margin-top: var(--space-lg); display: none;" id="telemetry-chart-section">
                        <div class="text-center">
                            <i data-lucide="activity" class="w-8 h-8 mx-auto mb-2 text-industrial-gray-400"></i>
                            <p>Telemetry History Chart</p>
                            <p class="text-xs">Chart.js integration for trend analysis</p>
                        </div>
                     </div>
                 </div>
                 
                 <!-- Alerts Tab -->
                 <div id="alerts-tab" class="tab-content">
                     <div class="alerts-list" id="modal-alerts-list">
                         <!-- Alerts will be populated by JavaScript -->
                     </div>
                     
                     <div class="module-actions">
                         <button class="btn-module-action" onclick="acknowledgeAlerts()">
                             <i data-lucide="check" class="w-4 h-4" aria-hidden="true"></i>
                             Acknowledge All
                         </button>
                         <button class="btn-module-action" onclick="clearAlerts()">
                             <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                             Clear All
                         </button>
                     </div>
                 </div>
                 
                 <!-- Logs Tab -->
                 <div id="logs-tab" class="tab-content">
                     <div class="logs-list" id="modal-logs-list">
                         <!-- Logs will be populated by JavaScript -->
                     </div>
                     
                     <div class="module-actions">
                         <button class="btn-module-action" onclick="exportLogs()">
                             <i data-lucide="download" class="w-4 h-4" aria-hidden="true"></i>
                             Export Logs
                         </button>
                         <button class="btn-module-action" onclick="clearLogs()">
                             <i data-lucide="trash-2" class="w-4 h-4" aria-hidden="true"></i>
                             Clear Logs
                         </button>
                     </div>
                 </div>
             </div>
         </div>
     </div>

     <script>
        // Initialize Lucide icons
        lucide.createIcons && lucide.createIcons();
        
        // RS485 API Client
        // 🎯 DEVELOPMENT MODE - Set to false to disable API calls
        const USE_REAL_API = false;
        
        class RS485APIClient {
            constructor() {
                this.baseURL = 'http://localhost:8000/api/v1/rs485';
                this.token = localStorage.getItem('jwt_token') || 'demo-token';
            }
            
            async makeRequest(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`
                    }
                };
                
                const requestOptions = { ...defaultOptions, ...options };
                
                try {
                    console.log(`🔌 RS485 API: ${options.method || 'GET'} ${url}`);
                    const response = await fetch(url, requestOptions);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log(`✅ RS485 API Response:`, data);
                    return data;
                } catch (error) {
                    console.error(`❌ RS485 API Error:`, error);
                    // Fallback to mock data in case of API error
                    console.warn('🧪 Falling back to mock data due to API error');
                    throw error;
                }
            }
            
            async getModules() {
                return this.makeRequest('/modules');
            }
            
            async getModule(address) {
                return this.makeRequest(`/modules/${address}`);
            }
            
            async getBusHealth() {
                return this.makeRequest('/bus/health');
            }
            
            async startDiscovery() {
                return this.makeRequest('/discovery/start', { method: 'POST' });
            }
            
            async getDiscoveryStatus() {
                return this.makeRequest('/discovery/status');
            }
            
            async getDiscoveryResults() {
                return this.makeRequest('/discovery/results');
            }
            
            async pingModule(address) {
                return this.makeRequest(`/modules/${address}/ping`, { method: 'POST' });
            }
            
            async resetModule(address) {
                return this.makeRequest(`/modules/${address}/reset`, { method: 'POST' });
            }
            
            async restartBus() {
                const body = JSON.stringify({ action: 'restart', force: false });
                return this.makeRequest('/bus/restart', { 
                    method: 'POST', 
                    body 
                });
            }
        }
        
        // Global RS485 API client instance
        const rs485API = new RS485APIClient();
        
        // RS485 WebSocket Client
        class RS485WebSocketClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000; // 1 second
                this.url = 'ws://localhost:8000/ws/rs485';
            }
            
            async connect() {
                try {
                    console.log('🔌 Connecting to RS485 WebSocket...');
                    this.ws = new WebSocket(this.url);
                    
                    this.ws.onopen = (event) => {
                        this.isConnected = true;
                        this.reconnectAttempts = 0;
                        console.log('✅ RS485 WebSocket connected');
                        this.onConnectionStatusChange(true);
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleMessage(message);
                        } catch (error) {
                            console.error('❌ Failed to parse WebSocket message:', error);
                        }
                    };
                    
                    this.ws.onclose = (event) => {
                        this.isConnected = false;
                        console.log('🔌 RS485 WebSocket disconnected');
                        this.onConnectionStatusChange(false);
                        this.attemptReconnect();
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('❌ RS485 WebSocket error:', error);
                        this.onConnectionStatusChange(false);
                    };
                    
                } catch (error) {
                    console.error('❌ Failed to create RS485 WebSocket connection:', error);
                    this.attemptReconnect();
                }
            }
            
            disconnect() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                this.isConnected = false;
            }
            
            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`🔄 Attempting to reconnect RS485 WebSocket (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                    setTimeout(() => {
                        this.connect();
                    }, this.reconnectDelay * this.reconnectAttempts);
                } else {
                    console.error('❌ Max reconnection attempts reached for RS485 WebSocket');
                }
            }
            
            handleMessage(message) {
                console.log('📡 RS485 WebSocket message:', message.type);
                
                switch (message.type) {
                    case 'rs485_initial':
                    case 'rs485_update':
                        this.updateModulesData(message.data);
                        break;
                    case 'rs485_module_action':
                        this.handleModuleAction(message.data);
                        break;
                    case 'rs485_discovery':
                        this.updateDiscoveryStatus(message.data);
                        break;
                    case 'rs485_bus_health':
                        this.updateBusHealth(message.data);
                        break;
                    default:
                        console.log('❓ Unknown RS485 WebSocket message type:', message.type);
                }
            }
            
            updateModulesData(data) {
                if (data.modules) {
                    // Update global modules data
                    rs485ModulesData = data.modules.map(module => ({
                        addr: module.addr,
                        name: module.name,
                        status: module.status,
                        last_seen: module.last_seen,
                        error_rate: module.error_rate,
                        response_time: module.response_time,
                        fw_version: module.fw_version,
                        mandatory: module.mandatory,
                        real_time: module.real_time
                    }));
                    
                    // Update UI if RS485 tab is active
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'tab-rs485') {
                        updateRs485ModuleGrid();
                        updateRs485DetailPanel();
                    }
                    
                    console.log('✅ Updated RS485 modules data from WebSocket:', rs485ModulesData.length, 'modules');
                }
                
                if (data.bus_health) {
                    updateRs485BusKpis(data.bus_health);
                }
            }
            
            handleModuleAction(data) {
                console.log(`⚡ Module action: ${data.action} on ${data.module_addr} - ${data.result.success ? 'Success' : 'Failed'}`);
                // Could show notification or update UI
            }
            
            updateDiscoveryStatus(data) {
                console.log(`🔍 Discovery update: ${data.status_message} (${data.progress}%)`);
                // Update discovery UI elements
                const prog = document.getElementById('disc-progress');
                const progressBar = document.getElementById('disc-progress-bar');
                
                if (prog) prog.textContent = data.status_message;
                if (progressBar) progressBar.style.width = `${data.progress}%`;
            }
            
            updateBusHealth(data) {
                console.log('📊 Bus health update:', data.status);
                updateRs485BusKpis(data);
            }
            
            onConnectionStatusChange(connected) {
                // Update UI to show WebSocket connection status
                const indicator = document.getElementById('rs485-ws-status');
                if (indicator) {
                    indicator.className = connected ? 'ws-connected' : 'ws-disconnected';
                    indicator.title = connected ? 'WebSocket connected - Real-time updates' : 'WebSocket disconnected - Using API polling';
                }
            }
        }
        
        // Global RS485 WebSocket client instance
        const rs485WS = new RS485WebSocketClient();
        
        class MonitoringController {
            constructor() {
                this.isMonitoring = true;
                this.refreshInterval = 5000; // 5 seconds
                this.initializeEventListeners();
                this.startRealTimeUpdates();
                this.initializeAccessibility();
            }
            
            initializeEventListeners() {
                // Refresh data
                document.getElementById('refresh-data').addEventListener('click', () => {
                    this.refreshData();
                });
                
                // Clear alerts
                document.getElementById('clear-alerts').addEventListener('click', () => {
                    this.clearAllAlerts();
                });
                
                // Pause monitoring
                document.getElementById('pause-monitoring').addEventListener('click', () => {
                    this.toggleMonitoring();
                });
                
                // Fullscreen
                document.getElementById('fullscreen').addEventListener('click', () => {
                    this.toggleFullscreen();
                });
                
                // Log level filter
                document.getElementById('log-level-filter').addEventListener('change', (e) => {
                    this.filterLogs(e.target.value);
                });
                
                // Export logs
                document.getElementById('export-logs').addEventListener('click', () => {
                    this.exportLogs();
                });
                
                // E-Stop
                document.querySelector('.btn-emergency').addEventListener('click', () => {
                    this.triggerEmergencyStop();
                });
            }
            
            initializeAccessibility() {
                // Add keyboard navigation
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.triggerEmergencyStop();
                    }
                    if (e.key === 'F11') {
                        this.toggleFullscreen();
                    }
                });
                
                // Add ARIA live regions for status updates
                const statusElements = document.querySelectorAll('[id$="-status"]');
                statusElements.forEach(el => {
                    el.setAttribute('aria-live', 'polite');
                });
                
                // Add ARIA live region for alerts
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.setAttribute('aria-live', 'assertive');
            }
            
            refreshData() {
                // Simulate data refresh
                this.updateMetrics();
                this.addLogEntry('info', 'Monitoring data refreshed');
                
                // Visual feedback
                const refreshBtn = document.getElementById('refresh-data');
                refreshBtn.classList.add('animate-spin');
                setTimeout(() => {
                    refreshBtn.classList.remove('animate-spin');
                }, 1000);
            }
            
            clearAllAlerts() {
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = '';
                this.addLogEntry('info', 'All alerts cleared');
            }
            
            toggleMonitoring() {
                this.isMonitoring = !this.isMonitoring;
                const pauseBtn = document.getElementById('pause-monitoring');
                const icon = pauseBtn.querySelector('i');
                
                if (this.isMonitoring) {
                    pauseBtn.innerHTML = '<i data-lucide="pause" class="w-4 h-4" aria-hidden="true"></i>Pause';
                    this.addLogEntry('info', 'Monitoring resumed');
                } else {
                    pauseBtn.innerHTML = '<i data-lucide="play" class="w-4 h-4" aria-hidden="true"></i>Resume';
                    this.addLogEntry('warning', 'Monitoring paused');
                }
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
            
            filterLogs(level) {
                const logEntries = document.querySelectorAll('.log-entry');
                logEntries.forEach(entry => {
                    if (level === 'all' || entry.classList.contains(`log-${level}`)) {
                        entry.style.display = 'block';
                    } else {
                        entry.style.display = 'none';
                    }
                });
            }
            
            exportLogs() {
                const logEntries = document.querySelectorAll('.log-entry');
                let logText = 'OHT-50 System Logs\n';
                logText += '==================\n\n';
                
                logEntries.forEach(entry => {
                    const timestamp = entry.querySelector('.log-timestamp').textContent;
                    const level = entry.querySelector('.log-level').textContent;
                    const message = entry.textContent.replace(timestamp, '').replace(level, '').trim();
                    logText += `${timestamp} [${level}] ${message}\n`;
                });
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `oht50-logs-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.addLogEntry('info', 'System logs exported');
            }
            
            triggerEmergencyStop() {
                // Update UI
                document.getElementById('overall-status').textContent = 'E-STOP';
                document.getElementById('overall-status').className = 'status-indicator status-critical';
                
                // Add to logs
                this.addLogEntry('error', 'Emergency stop activated');
                
                // Announce to screen readers
                this.announceToScreenReader('Emergency stop activated. All systems halted.');
                
                // Visual feedback
                document.body.style.backgroundColor = '#fee2e2';
                setTimeout(() => {
                    document.body.style.backgroundColor = '';
                }, 1000);
            }
            
            updateMetrics() {
                // Simulate changing metrics
                const cpuUsage = Math.floor(Math.random() * 60) + 20;
                const memoryUsage = Math.floor(Math.random() * 30) + 50;
                const diskUsage = Math.floor(Math.random() * 20) + 15;
                const networkIO = (Math.random() * 5 + 1).toFixed(1);
                
                document.getElementById('memory-usage').textContent = `${memoryUsage}%`;
                document.getElementById('disk-usage').textContent = `${diskUsage}%`;
                document.getElementById('network-io').textContent = `${networkIO} MB/s`;
                
                // Update CPU gauge
                const cpuGauge = document.querySelector('.gauge-circle');
                cpuGauge.style.setProperty('--percentage', cpuUsage);
                cpuGauge.querySelector('.gauge-center').textContent = `${cpuUsage}%`;
                
                // Update status indicators based on thresholds
                if (memoryUsage > 80) {
                    document.getElementById('memory-usage').parentElement.querySelector('.status-indicator').className = 'status-indicator status-warning';
                    this.addAlert('warning', 'High Memory Usage', `Memory usage is above 80% threshold (${memoryUsage}%)`);
                }
                
                if (cpuUsage > 70) {
                    document.getElementById('overall-status').textContent = 'WARNING';
                    document.getElementById('overall-status').className = 'status-indicator status-warning';
                }
            }
            
            addAlert(level, title, message) {
                const alertsContainer = document.getElementById('alerts-container');
                const alertItem = document.createElement('div');
                alertItem.className = `alert-item alert-${level}`;
                
                const icons = {
                    info: 'info',
                    warning: 'alert-triangle',
                    error: 'alert-circle',
                    success: 'check-circle'
                };
                
                alertItem.innerHTML = `
                    <i data-lucide="${icons[level]}" class="alert-icon text-${level === 'info' ? 'info-blue' : level === 'warning' ? 'warning-yellow' : level === 'error' ? 'error-red' : 'success-green'}" aria-hidden="true"></i>
                    <div class="alert-content">
                        <div class="alert-title">${title}</div>
                        <div class="alert-message">${message}</div>
                        <div class="alert-time">Just now</div>
                    </div>
                    <button class="btn btn-secondary btn-sm" aria-label="Dismiss alert">
                        <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                    </button>
                `;
                
                alertsContainer.insertBefore(alertItem, alertsContainer.firstChild);
                
                // Keep only last 10 alerts
                while (alertsContainer.children.length > 10) {
                    alertsContainer.removeChild(alertsContainer.lastChild);
                }
            }
            
            addLogEntry(level, message) {
                const logContainer = document.getElementById('log-entries');
                const timestamp = new Date().toLocaleTimeString();
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${level}`;
                logEntry.innerHTML = `
                    <span class="log-timestamp">${timestamp}</span>
                    <span class="log-level">${level.toUpperCase()}</span>
                    <span>${message}</span>
                `;
                
                logContainer.insertBefore(logEntry, logContainer.firstChild);
                
                // Keep only last 50 entries
                while (logContainer.children.length > 50) {
                    logContainer.removeChild(logContainer.lastChild);
                }
            }
            
            announceToScreenReader(message) {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'assertive');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    document.body.removeChild(announcement);
                }, 1000);
            }
            
            startRealTimeUpdates() {
                // Update metrics every 5 seconds
                setInterval(() => {
                    if (this.isMonitoring) {
                        this.updateMetrics();
                    }
                }, this.refreshInterval);
                
                // Update timestamp
                setInterval(() => {
                    document.getElementById('last-update').textContent = 
                        new Date().toLocaleString();
                }, 1000);
            }
        }
        
                 // RS485 Module Functions & Health Thresholds
         const mandatoryAddresses = [0x01,0x02,0x03,0x04,0x05];
         const usedOptional = [0x06,0x07]; // 0x08–0x0F reserved

         // Health Status Thresholds Configuration
         const HEALTH_THRESHOLDS = {
             // Module Health Thresholds
             module: {
                 error_rate: {
                     healthy: 0.01,    // < 1%
                     warning: 0.03,    // 1-3%
                     error: 0.05       // > 3%
                 },
                 response_time_p95: {
                     healthy: 100,     // < 100ms
                     warning: 300,     // 100-300ms
                     error: 500        // > 300ms
                 },
                 last_seen: {
                     healthy: 30,      // < 30 seconds
                     warning: 60,      // 30-60 seconds
                     error: 120        // > 60 seconds
                 }
             },
             
             // Bus Health Thresholds
             bus: {
                 error_rate: {
                     healthy: 0.02,    // < 2%
                     warning: 0.05,    // 2-5%
                     error: 0.10       // > 5%
                 },
                 response_time_p95: {
                     healthy: 70,      // < 70ms
                     warning: 150,     // 70-150ms
                     error: 300        // > 150ms
                 },
                 throughput: {
                     healthy: 50,      // > 50 fps
                     warning: 30,      // 30-50 fps
                     error: 20         // < 30 fps
                 }
             },
             
             // System Health Thresholds
             system: {
                 cpu_usage: {
                     healthy: 70,      // < 70%
                     warning: 85,      // 70-85%
                     error: 95         // > 85%
                 },
                 memory_usage: {
                     healthy: 80,      // < 80%
                     warning: 90,      // 80-90%
                     error: 95         // > 90%
                 },
                 disk_usage: {
                     healthy: 85,      // < 85%
                     warning: 95,      // 85-95%
                     error: 98         // > 95%
                 }
             }
         };

         // Health Status Mappings
         const HEALTH_STATUS = {
             healthy: {
                 class: 'healthy',
                 color: 'var(--success-green)',
                 icon: 'check-circle',
                 text: 'Healthy',
                 description: 'All systems operating normally'
             },
             warning: {
                 class: 'warn',
                 color: 'var(--warning-yellow)',
                 icon: 'alert-triangle',
                 text: 'Warning',
                 description: 'Performance degradation detected'
             },
             error: {
                 class: 'error',
                 color: 'var(--error-red)',
                 icon: 'alert-circle',
                 text: 'Error',
                 description: 'Critical issues detected'
             },
             lost: {
                 class: 'lost',
                 color: 'var(--industrial-gray-400)',
                 icon: 'x-circle',
                 text: 'Lost',
                 description: 'Module not responding'
             }
         };

         function healthClassFromMetrics(m) {
             // Check if module is lost (no response for > 2 minutes)
             const lastSeenSeconds = getSecondsSinceLastSeen(m.last_seen);
             if (lastSeenSeconds > HEALTH_THRESHOLDS.module.last_seen.error) {
                 return 'lost';
             }
             
             // Check error rate thresholds
             if (m.error_rate > HEALTH_THRESHOLDS.module.error_rate.error) {
                 return 'error';
             }
             if (m.error_rate > HEALTH_THRESHOLDS.module.error_rate.warning) {
                 return 'warn';
             }
             
             // Check response time thresholds
             if (m.response_time_p95 > HEALTH_THRESHOLDS.module.response_time_p95.error) {
                 return 'error';
             }
             if (m.response_time_p95 > HEALTH_THRESHOLDS.module.response_time_p95.warning) {
                 return 'warn';
             }
             
             return 'healthy';
         }
         
         function getBusHealthStatus(bus) {
             // Check bus error rate
             if (bus.error_rate_bus > HEALTH_THRESHOLDS.bus.error_rate.error) {
                 return 'error';
             }
             if (bus.error_rate_bus > HEALTH_THRESHOLDS.bus.error_rate.warning) {
                 return 'warning';
             }
             
             // Check bus response time
             if (bus.response_time_p95_bus > HEALTH_THRESHOLDS.bus.response_time_p95.error) {
                 return 'error';
             }
             if (bus.response_time_p95_bus > HEALTH_THRESHOLDS.bus.response_time_p95.warning) {
                 return 'warning';
             }
             
             // Check bus throughput
             if (bus.throughput_bus < HEALTH_THRESHOLDS.bus.throughput.error) {
                 return 'error';
             }
             if (bus.throughput_bus < HEALTH_THRESHOLDS.bus.throughput.warning) {
                 return 'warning';
             }
             
             return 'healthy';
         }
         
         function getSystemHealthStatus(metrics) {
             const statuses = [];
             
             // Check CPU usage
             if (metrics.cpu_usage > HEALTH_THRESHOLDS.system.cpu_usage.error) {
                 statuses.push('error');
             } else if (metrics.cpu_usage > HEALTH_THRESHOLDS.system.cpu_usage.warning) {
                 statuses.push('warning');
             } else {
                 statuses.push('healthy');
             }
             
             // Check memory usage
             if (metrics.memory_usage > HEALTH_THRESHOLDS.system.memory_usage.error) {
                 statuses.push('error');
             } else if (metrics.memory_usage > HEALTH_THRESHOLDS.system.memory_usage.warning) {
                 statuses.push('warning');
             } else {
                 statuses.push('healthy');
             }
             
             // Check disk usage
             if (metrics.disk_usage > HEALTH_THRESHOLDS.system.disk_usage.error) {
                 statuses.push('error');
             } else if (metrics.disk_usage > HEALTH_THRESHOLDS.system.disk_usage.warning) {
                 statuses.push('warning');
             } else {
                 statuses.push('healthy');
             }
             
             // Return worst status
             if (statuses.includes('error')) return 'error';
             if (statuses.includes('warning')) return 'warning';
             return 'healthy';
         }
         
         function getSecondsSinceLastSeen(lastSeenStr) {
             // Parse last seen time string and return seconds since
             const now = new Date();
             const lastSeen = new Date(lastSeenStr);
             return Math.floor((now - lastSeen) / 1000);
         }
         
         function getHealthStatusInfo(status) {
             return HEALTH_STATUS[status] || HEALTH_STATUS.healthy;
         }

        function updateRs485BusKpis(bus) {
            const el = document.getElementById('bus-kpis');
            if (!el) return;
            el.innerHTML = `
                <div class="bus-kpi-card">
                    <div class="bus-kpi-value">${(bus.error_rate_bus*100).toFixed(2)}%</div>
                    <div class="bus-kpi-label">Error Rate</div>
                </div>
                <div class="bus-kpi-card">
                    <div class="bus-kpi-value">${bus.response_time_p95_bus} ms</div>
                    <div class="bus-kpi-label">Response P95</div>
                </div>
                <div class="bus-kpi-card">
                    <div class="bus-kpi-value">${bus.throughput_bus} fps</div>
                    <div class="bus-kpi-label">Throughput</div>
                </div>
                <div class="bus-kpi-card">
                    <div class="bus-kpi-value">${bus.last_scan}</div>
                    <div class="bus-kpi-label">Last Scan</div>
                </div>
            `;
            
            // Update bus status
            updateBusStatus(bus);
        }
        
                 function updateBusStatus(bus) {
             const indicator = document.getElementById('bus-status-indicator');
             const statusText = document.getElementById('bus-status-text');
             
             if (!indicator || !statusText) return;
             
             const busStatus = getBusHealthStatus(bus);
             const statusInfo = getHealthStatusInfo(busStatus);
             
             indicator.className = `bus-status-indicator ${busStatus}`;
             statusText.textContent = statusInfo.text;
             
             // Add tooltip with description
             statusText.title = statusInfo.description;
         }

        function renderModuleGrid(modules) {
            console.log('🎯 Rendering module grid with modules:', modules.length);
            
            const grid = document.getElementById('rs485-module-grid');
            console.log('📋 Grid element found:', grid);
            
            if (!grid) {
                console.error('❌ rs485-module-grid element not found!');
                return;
            }
            
            grid.innerHTML = '';
            console.log('🧹 Grid cleared, adding modules...');
            
            modules.forEach((m, index) => {
                console.log(`📦 Adding module ${index + 1}:`, m.name, m.addr);
                const wrap = document.createElement('div');
                wrap.className = 'module-card';
                wrap.setAttribute('role','gridcell');
                wrap.tabIndex = 0;
                const statusClass = healthClassFromMetrics(m);
                wrap.innerHTML = `
                    <div class="module-card-header">
                        <div>
                            <div class="module-name">${m.name || 'Module'}</div>
                            <div class="module-address">0x${m.addr.toString(16).padStart(2,'0').toUpperCase()}</div>
                        </div>
                        <span class="module-status ${statusClass}" aria-live="polite">${statusClass}</span>
                    </div>
                    <div class="module-badge ${m.mandatory ? 'mandatory' : 'optional'}">${m.mandatory ? 'Mandatory' : 'Optional'}</div>
                    <div class="module-metrics">
                        <div class="module-metric">
                            <span class="metric-label">Last Seen</span>
                            <span class="metric-value">${m.last_seen}</span>
                        </div>
                        <div class="module-metric">
                            <span class="metric-label">FW Version</span>
                            <span class="metric-value">${m.fw_version}</span>
                        </div>
                        <div class="module-metric">
                            <span class="metric-label">Error Rate</span>
                            <span class="metric-value">${(m.error_rate*100).toFixed(2)}%</span>
                        </div>
                        <div class="module-metric">
                            <span class="metric-label">Response P95</span>
                            <span class="metric-value">${m.response_time_p95} ms</span>
                        </div>
                    </div>
                `;
                
                // Add click handlers with debug
                console.log(`🖱️ Adding click handler for module ${m.name} (${m.addr})`);
                wrap.addEventListener('click', (e) => {
                    console.log('🔄 Module clicked:', m.name, m.addr);
                    openModuleDetail(m.addr);
                });
                wrap.addEventListener('keydown', (e) => { 
                    if (e.key === 'Enter') {
                        console.log('⌨️ Module Enter key pressed:', m.name, m.addr);
                        openModuleDetail(m.addr);
                    }
                });
                
                grid.appendChild(wrap);
            });
            
            console.log('✅ Module grid rendering completed');
        }

        function openModuleDetail(addr) {
            console.log('🔄 Opening module detail for address:', addr);
            
            const dlg = document.getElementById('module-detail-modal');
            console.log('📋 Modal element found:', dlg);
            
            const module = mockModules().find(m => m.addr === addr);
            console.log('📊 Module data found:', module);
            
            if (!module) {
                console.error('❌ No module found for address:', addr);
                return;
            }
            
            if (!dlg) {
                console.error('❌ Modal element not found!');
                return;
            }
            
            // Update modal title
            document.getElementById('module-modal-title').textContent = `Module [0x${addr.toString(16).padStart(2,'0').toUpperCase()}]`;
            
            // Populate overview data
            document.getElementById('modal-module-name').textContent = module.name;
            document.getElementById('modal-module-addr').textContent = `0x${addr.toString(16).padStart(2,'0').toUpperCase()}`;
            document.getElementById('modal-module-type').textContent = module.mandatory ? 'Mandatory' : 'Optional';
            document.getElementById('modal-module-fw').textContent = module.fw_version;
            document.getElementById('modal-module-status').textContent = healthClassFromMetrics(module).toUpperCase();
            document.getElementById('modal-module-last-seen').textContent = module.last_seen;
            document.getElementById('modal-module-error-rate').textContent = `${(module.error_rate*100).toFixed(2)}%`;
            document.getElementById('modal-module-response-p95').textContent = `${module.response_time_p95} ms`;
            
            // Populate alerts and logs
            populateModalAlerts(addr);
            populateModalLogs(addr);
            
            // 🎯 Initialize tabs properly
            // Reset all tabs to inactive
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate overview tab by default
            document.querySelector('.modal-tab[onclick*="overview"]').classList.add('active');
            document.getElementById('overview-tab').classList.add('active');
            
            console.log('🎯 Modal tabs initialized');
            
            // Show modal
            dlg.setAttribute('open', '');
            
            // Debug: Check telemetry tab after modal opens
            setTimeout(() => {
                const telemetryTab = document.getElementById('telemetry-tab');
                console.log('📊 Telemetry tab after modal open:', telemetryTab);
                console.log('📊 Telemetry tab classes:', telemetryTab?.className);
            }, 100);
        }
        
        function closeModuleDetail() {
            const dlg = document.getElementById('module-detail-modal');
            dlg.removeAttribute('open');
        }
        
        function switchTab(tabName) {
            console.log('🔄 Switching to tab:', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                console.log('Hiding tab:', tab.id);
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('✅ Showing tab:', targetTab.id);
            } else {
                console.error('❌ Tab not found:', `${tabName}-tab`);
            }
            
            // Add active class to clicked tab
            if (event && event.target) {
            event.target.classList.add('active');
            } else {
                // Fallback: find the tab button by text content
                document.querySelectorAll('.modal-tab').forEach(tab => {
                    if (tab.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                        tab.classList.add('active');
                    }
                });
            }
        }
        
        function populateModalAlerts(addr) {
            const alertsList = document.getElementById('modal-alerts-list');
            const alerts = generateMockAlerts(addr);
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item-small ${alert.level}">
                    <i data-lucide="${alert.icon}" class="w-4 h-4" aria-hidden="true"></i>
                    <div>
                        <div class="font-medium">${alert.title}</div>
                        <div class="text-xs text-industrial-gray-600">${alert.message}</div>
                    </div>
                    <div class="text-xs text-industrial-gray-500 ml-auto">${alert.time}</div>
                </div>
            `).join('');
        }
        
        function populateModalLogs(addr) {
            const logsList = document.getElementById('modal-logs-list');
            const logs = generateMockLogs(addr);
            
            logsList.innerHTML = logs.map(log => `
                <div class="log-item">
                    <span class="log-timestamp-small">${log.timestamp}</span>
                    <span class="log-level-small ${log.level}">${log.level.toUpperCase()}</span>
                    <span>${log.message}</span>
                </div>
            `).join('');
        }
        
        function generateMockAlerts(addr) {
            const levels = ['info', 'warning', 'error'];
            const titles = [
                'Module responding normally',
                'High error rate detected',
                'Connection timeout',
                'Firmware update available',
                'Temperature warning'
            ];
            const messages = [
                'All systems operational',
                'Error rate above 2% threshold',
                'No response for 30 seconds',
                'New firmware v1.3.0 available',
                'Temperature approaching limit'
            ];
            
            return Array.from({length: 3}, (_, i) => ({
                level: levels[Math.floor(Math.random() * levels.length)],
                icon: ['info', 'alert-triangle', 'alert-circle'][Math.floor(Math.random() * 3)],
                title: titles[Math.floor(Math.random() * titles.length)],
                message: messages[Math.floor(Math.random() * messages.length)],
                time: `${Math.floor(Math.random() * 60)}m ago`
            }));
        }
        
        function generateMockLogs(addr) {
            const levels = ['info', 'warning', 'error', 'success'];
            const messages = [
                'Module ping successful',
                'Data transmission completed',
                'Configuration updated',
                'Error rate check passed',
                'Connection established',
                'Telemetry data received',
                'Status check completed'
            ];
            
            return Array.from({length: 10}, (_, i) => ({
                timestamp: new Date(Date.now() - i * 60000).toLocaleTimeString(),
                level: levels[Math.floor(Math.random() * levels.length)],
                message: messages[Math.floor(Math.random() * messages.length)]
            }));
        }
        
        // Module action functions
        async function pingModule() {
            const addr = getCurrentModuleAddr();
            console.log(`Pinging module 0x${addr.toString(16).padStart(2,'0').toUpperCase()}`);
            
            // Add visual feedback
            const btn = event.target.closest('.btn-module-action');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin" aria-hidden="true"></i>Pinging...';
            btn.disabled = true;
            
            try {
                const response = await rs485API.pingModule(addr);
                if (response.success) {
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4" aria-hidden="true"></i>Ping Success!';
                    btn.style.background = 'var(--success-green)';
                    console.log(`✅ Ping successful: ${response.data.message}`);
                } else {
                    btn.innerHTML = '<i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>Ping Failed';
                    btn.style.background = 'var(--error-red)';
                    console.error(`❌ Ping failed: ${response.message}`);
                }
            } catch (error) {
                console.error(`❌ Ping error:`, error);
                btn.innerHTML = '<i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>Ping Error';
                btn.style.background = 'var(--error-red)';
            }
            
            // Reset button after delay
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
                btn.disabled = false;
            }, 2000);
        }
        
        async function retryModule() {
            const addr = getCurrentModuleAddr();
            console.log(`Retrying connection to module 0x${addr.toString(16).padStart(2,'0').toUpperCase()}`);
            
            // Add visual feedback
            const btn = event.target.closest('.btn-module-action');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin" aria-hidden="true"></i>Retrying...';
            btn.disabled = true;
            
            try {
                const response = await rs485API.resetModule(addr);
                if (response.success) {
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4" aria-hidden="true"></i>Reset Success!';
                    btn.style.background = 'var(--success-green)';
                    console.log(`✅ Reset successful: ${response.data.message}`);
                } else {
                    btn.innerHTML = '<i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>Reset Failed';
                    btn.style.background = 'var(--error-red)';
                    console.error(`❌ Reset failed: ${response.message}`);
                }
            } catch (error) {
                console.error(`❌ Reset error:`, error);
                btn.innerHTML = '<i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>Reset Error';
                btn.style.background = 'var(--error-red)';
            }
            
            // Reset button after delay
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = '';
                btn.disabled = false;
            }, 3000);
        }
        
        async function quarantineModule() {
            const addr = getCurrentModuleAddr();
            if (confirm(`Are you sure you want to quarantine module 0x${addr.toString(16).padStart(2,'0').toUpperCase()}?`)) {
                console.log(`Quarantining module 0x${addr.toString(16).padStart(2,'0').toUpperCase()}`);
                
                try {
                    // Note: Quarantine API endpoint not implemented yet, so just log
                    console.log(`⚠️  Module 0x${addr.toString(16).padStart(2,'0').toUpperCase()} would be quarantined`);
                    alert(`Module 0x${addr.toString(16).padStart(2,'0').toUpperCase()} quarantined successfully!`);
                closeModuleDetail();
                } catch (error) {
                    console.error(`❌ Quarantine error:`, error);
                    alert(`Failed to quarantine module: ${error.message}`);
                }
            }
        }
        
        function getCurrentModuleAddr() {
            const title = document.getElementById('module-modal-title').textContent;
            const match = title.match(/0x([0-9A-F]+)/);
            return match ? parseInt(match[1], 16) : 0x01;
        }
        
        function exportTelemetry() {
            console.log('Exporting telemetry data...');
            // Implementation for telemetry export
        }
        
        function clearTelemetry() {
            if (confirm('Are you sure you want to clear telemetry history?')) {
                console.log('Clearing telemetry history...');
            }
        }
        
        function acknowledgeAlerts() {
            console.log('Acknowledging all alerts...');
            document.getElementById('modal-alerts-list').innerHTML = '';
        }
        
        function clearAlerts() {
            if (confirm('Are you sure you want to clear all alerts?')) {
                console.log('Clearing all alerts...');
                document.getElementById('modal-alerts-list').innerHTML = '';
            }
        }
        
        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                console.log('Clearing all logs...');
                document.getElementById('modal-logs-list').innerHTML = '';
            }
        }

        async function startDiscovery() {
            const prog = document.getElementById('disc-progress');
            const progressBar = document.getElementById('disc-progress-bar');
            const list = document.getElementById('disc-collisions');
            const scanBtn = document.getElementById('btn-scan');
            
            if (!prog || !progressBar || !list || !scanBtn) return;
            
            // Disable scan button during discovery
            scanBtn.disabled = true;
            scanBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin" aria-hidden="true"></i>Scanning...';
            
            try {
                // Start real discovery via API
                console.log('🔍 Starting RS485 discovery via API...');
                await rs485API.startDiscovery();
                
                // Poll discovery status
                const pollStatus = async () => {
                    try {
                        const statusResponse = await rs485API.getDiscoveryStatus();
                        if (statusResponse.success && statusResponse.data) {
                            const status = statusResponse.data;
                            
                            // Update UI
                            prog.textContent = status.status_message;
                            progressBar.style.width = `${status.progress}%`;
                            
                            if (status.is_running) {
                                // Continue polling
                                setTimeout(pollStatus, 500);
                            } else {
                                // Discovery completed
                                await showDiscoveryResults();
                                
                                // Re-enable scan button
                                scanBtn.disabled = false;
                                scanBtn.innerHTML = '<i data-lucide="search" class="w-4 h-4" aria-hidden="true"></i>Scan Now';
                            }
                        }
                    } catch (error) {
                        console.error('❌ Discovery status polling error:', error);
                        // Fallback to mock behavior
                        fallbackDiscovery();
                    }
                };
                
                // Start polling
                setTimeout(pollStatus, 500);
                
            } catch (error) {
                console.error('❌ Discovery start error:', error);
                // Fallback to mock behavior
                fallbackDiscovery();
            }
            
            function fallbackDiscovery() {
            let pct = 0;
            list.innerHTML = '';
            
            const t = setInterval(() => {
                pct += 10;
                prog.textContent = `Scanning... ${pct}%`;
                progressBar.style.width = `${pct}%`;
                
                if (pct >= 100) {
                    clearInterval(t);
                    prog.textContent = 'Scan complete · 7 modules found · 0 collisions';
                    
                    // Show discovery results
                    showDiscoveryResults();
                    
                    // Re-enable scan button
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = '<i data-lucide="search" class="w-4 h-4" aria-hidden="true"></i>Scan Now';
                }
            }, 200);
            }
        }
        
        async function showDiscoveryResults() {
            const list = document.getElementById('disc-collisions');
            if (!list) return;
            
            try {
                // Get real discovery results from API
                const resultsResponse = await rs485API.getDiscoveryResults();
                if (resultsResponse.success && resultsResponse.data) {
                    const foundModules = resultsResponse.data.map(result => ({
                        addr: result.address,
                        name: result.name,
                        status: result.found ? 'found' : 'not_found',
                        conflict: result.conflict
                    }));
                    
                    list.innerHTML = foundModules.map(m => `
                        <div class="discovery-item ${m.status}">
                            <div class="discovery-item-icon ${m.status}"></div>
                            <span>0x${m.addr.toString(16).padStart(2,'0').toUpperCase()} - ${m.name} ${m.conflict ? '⚠️' : ''}</span>
                        </div>
                    `).join('');
                    return;
                }
            } catch (error) {
                console.error('❌ Discovery results error:', error);
            }
            
            // Fallback to mock data
            const modules = await getModules();
            const foundModules = modules.map(m => ({
                addr: m.addr,
                name: m.name,
                status: 'found'
            }));
            
            list.innerHTML = foundModules.map(m => `
                <div class="discovery-item ${m.status}">
                    <div class="discovery-item-icon ${m.status}"></div>
                    <span>0x${m.addr.toString(16).padStart(2,'0').toUpperCase()} - ${m.name}</span>
                </div>
            `).join('');
        }

        // Real API functions (with mock fallback)
        async function getModules() {
            if (!USE_REAL_API) {
                console.log('🧪 Using mock data (API disabled)');
                return mockModulesFallback();
            }
            
            try {
                const response = await rs485API.getModules();
                if (response.success && response.data) {
                    return response.data.map(module => ({
                        addr: parseInt(module.address),
                        name: module.name,
                        mandatory: module.mandatory,
                        health: module.status === 'healthy' ? 'healthy' : 
                               module.status === 'warning' ? 'warn' : 
                               module.status === 'error' ? 'error' : 'lost',
                        error_rate: module.error_rate / 100, // Convert percentage to decimal
                        response_time_p95: module.response_time,
                        last_seen: module.last_seen,
                        fw_version: module.fw_version
                    }));
                }
            } catch (error) {
                console.warn('🧪 Using mock modules data due to API error:', error);
                return mockModulesFallback();
            }
        }
        
        async function getBusHealth() {
            if (!USE_REAL_API) {
                console.log('🧪 Using mock bus data (API disabled)');
                return mockBusFallback();
            }
            
            try {
                const response = await rs485API.getBusHealth();
                if (response.success && response.data) {
                    return {
                        error_rate_bus: response.data.error_rate / 100, // Convert percentage to decimal
                        response_time_p95_bus: response.data.response_time_p95,
                        throughput_bus: response.data.throughput,
                        last_scan: response.data.last_scan
                    };
                }
            } catch (error) {
                console.warn('🧪 Using mock bus data due to API error:', error);
                return mockBusFallback();
            }
        }
        
        // 💪 FORCE FIX: Mock data functions
        function mockModules() {
            console.log('💪 FORCE: Using hardcoded mock modules');
            return [
                { addr: 1, name: 'Power', mandatory: true, health: 'healthy', error_rate: 0.0191, response_time_p95: 79, last_seen: '2:34:34 PM', fw_version: 'v1.2.1' },
                { addr: 2, name: 'Safety', mandatory: true, health: 'healthy', error_rate: 0.0127, response_time_p95: 142, last_seen: '2:34:34 PM', fw_version: 'v1.2.2' },
                { addr: 3, name: 'Travel', mandatory: true, health: 'healthy', error_rate: 0.0070, response_time_p95: 76, last_seen: '2:34:34 PM', fw_version: 'v1.2.3' },
                { addr: 4, name: 'Dock & Location', mandatory: true, health: 'healthy', error_rate: 0.0019, response_time_p95: 168, last_seen: '2:34:34 PM', fw_version: 'v1.2.4' },
                { addr: 5, name: 'Master', mandatory: true, health: 'healthy', error_rate: 0.0114, response_time_p95: 68, last_seen: '2:34:34 PM', fw_version: 'v1.2.5' },
                { addr: 6, name: 'Lifter', mandatory: false, health: 'healthy', error_rate: 0.0021, response_time_p95: 163, last_seen: '2:34:34 PM', fw_version: 'v1.2.6' },
                { addr: 7, name: 'Cargo', mandatory: false, health: 'healthy', error_rate: 0.0178, response_time_p95: 118, last_seen: '2:34:34 PM', fw_version: 'v1.2.7' }
            ];
        }
        
        function mockModulesFallback() {
            console.log('💪 FORCE: Using fallback mock modules');
            return mockModules(); // Use same data
        }
        
        function mockBusFallback() {
            return {
                error_rate_bus: Math.random()*0.02,
                response_time_p95_bus: Math.floor(70 + Math.random()*100),
                throughput_bus: Math.floor(40 + Math.random()*20),
                last_scan: new Date().toLocaleTimeString()
            };
        }
                 async function tick() {
             try {
                 const modules = await getModules();
                 const bus = await getBusHealth();
             
             renderModuleGrid(modules);
             updateRs485BusKpis(bus);
             
             // Check for health threshold violations and generate alerts
             checkHealthThresholds(modules, bus);
             } catch (error) {
                 console.error('❌ Tick function error:', error);
                 // Continue with fallback data
                 const modules = mockModulesFallback();
                 const bus = mockBusFallback();
                 renderModuleGrid(modules);
                 updateRs485BusKpis(bus);
             }
             
             requestAnimationFrame(() => {});
         }
         
         function checkHealthThresholds(modules, bus) {
             // Check module health thresholds
             modules.forEach(module => {
                 const healthStatus = healthClassFromMetrics(module);
                 const moduleAddr = `0x${module.addr.toString(16).padStart(2,'0').toUpperCase()}`;
                 
                 // Generate alerts for warning and error states
                 if (healthStatus === 'error') {
                     addAlertWithModule('critical', 
                         `${module.name} Module Critical`, 
                         `Module ${moduleAddr} has critical health issues - Error rate: ${(module.error_rate*100).toFixed(2)}%, Response time: ${module.response_time_p95}ms`, 
                         moduleAddr, 
                         module.name);
                 } else if (healthStatus === 'warn') {
                     addAlertWithModule('warning', 
                         `${module.name} Module Warning`, 
                         `Module ${moduleAddr} showing performance degradation - Error rate: ${(module.error_rate*100).toFixed(2)}%, Response time: ${module.response_time_p95}ms`, 
                         moduleAddr, 
                         module.name);
                 } else if (healthStatus === 'lost') {
                     addAlertWithModule('critical', 
                         `${module.name} Module Lost`, 
                         `Module ${moduleAddr} is not responding - Last seen: ${module.last_seen}`, 
                         moduleAddr, 
                         module.name);
                 }
             });
             
             // Check bus health thresholds
             const busStatus = getBusHealthStatus(bus);
             if (busStatus === 'error') {
                 addAlertWithModule('critical', 
                     'RS485 Bus Critical', 
                     `Bus has critical issues - Error rate: ${(bus.error_rate_bus*100).toFixed(2)}%, Response time: ${bus.response_time_p95_bus}ms, Throughput: ${bus.throughput_bus}fps`, 
                     '0x00', 
                     'RS485 Bus');
             } else if (busStatus === 'warning') {
                 addAlertWithModule('warning', 
                     'RS485 Bus Warning', 
                     `Bus showing performance issues - Error rate: ${(bus.error_rate_bus*100).toFixed(2)}%, Response time: ${bus.response_time_p95_bus}ms, Throughput: ${bus.throughput_bus}fps`, 
                     '0x00', 
                     'RS485 Bus');
             }
         }
        tick();
        setInterval(tick, 1500);

                 // Alert Filter Functions
         function initializeAlertFilters() {
             const moduleFilter = document.getElementById('module-filter-select');
             const severityFilter = document.getElementById('severity-filter-select');
             
             if (moduleFilter) {
                 moduleFilter.addEventListener('change', filterAlerts);
             }
             
             if (severityFilter) {
                 severityFilter.addEventListener('change', filterAlerts);
             }
         }
         
         function filterAlerts() {
             const moduleFilter = document.getElementById('module-filter-select')?.value || 'all';
             const severityFilter = document.getElementById('severity-filter-select')?.value || 'all';
             const alerts = document.querySelectorAll('.alert-item');
             
             alerts.forEach(alert => {
                 const alertModule = alert.getAttribute('data-module');
                 const alertSeverity = alert.getAttribute('data-severity');
                 
                 const moduleMatch = moduleFilter === 'all' || alertModule === moduleFilter;
                 const severityMatch = severityFilter === 'all' || alertSeverity === severityFilter;
                 
                 if (moduleMatch && severityMatch) {
                     alert.classList.remove('hidden');
                 } else {
                     alert.classList.add('hidden');
                 }
             });
             
             updateAlertCount();
         }
         
         function updateAlertCount() {
             const visibleAlerts = document.querySelectorAll('.alert-item:not(.hidden)').length;
             const totalAlerts = document.querySelectorAll('.alert-item').length;
             
             // Update alert panel title to show count
             const alertTitle = document.querySelector('.alert-panel h3');
             if (alertTitle) {
                 alertTitle.textContent = `Active Alerts (${visibleAlerts}/${totalAlerts})`;
             }
         }
         
         function addAlertWithModule(level, title, message, moduleAddr, moduleName) {
             const alertsContainer = document.getElementById('alerts-container');
             const alertItem = document.createElement('div');
             
             const icons = {
                 info: 'info',
                 warning: 'alert-triangle',
                 error: 'alert-circle',
                 success: 'check-circle',
                 critical: 'alert-circle'
             };
             
             const colors = {
                 info: 'text-info-blue',
                 warning: 'text-warning-yellow',
                 error: 'text-error-red',
                 success: 'text-success-green',
                 critical: 'text-error-red'
             };
             
             alertItem.className = `alert-item alert-${level}`;
             alertItem.setAttribute('data-module', moduleAddr);
             alertItem.setAttribute('data-severity', level);
             
             alertItem.innerHTML = `
                 <i data-lucide="${icons[level]}" class="alert-icon ${colors[level]}" aria-hidden="true"></i>
                 <div class="alert-content">
                     <div class="alert-title">${title}</div>
                     <div class="alert-message">${message}</div>
                     <div class="alert-time">Just now</div>
                 </div>
                 <div class="alert-module-badge">${moduleName} (${moduleAddr})</div>
                 <button class="btn btn-secondary btn-sm" aria-label="Dismiss alert" onclick="dismissAlert(this)">
                     <i data-lucide="x" class="w-4 h-4" aria-hidden="true"></i>
                 </button>
             `;
             
             alertsContainer.insertBefore(alertItem, alertsContainer.firstChild);
             
             // Keep only last 10 alerts
             while (alertsContainer.children.length > 10) {
                 alertsContainer.removeChild(alertsContainer.lastChild);
             }
             
             updateAlertCount();
             
             // Re-apply current filters
             filterAlerts();
         }
         
         function dismissAlert(button) {
             const alertItem = button.closest('.alert-item');
             alertItem.remove();
             updateAlertCount();
         }

         // Tab Navigation System - Option C
         function switchTab(targetTabId) {
             console.log('switchTab called with:', targetTabId);
             
             // Get all tab buttons and contents
             const tabButtons = document.querySelectorAll('.tab-item');
             const tabContents = document.querySelectorAll('.tab-content');
             
             // Update tab buttons
             tabButtons.forEach(btn => {
                 btn.classList.remove('active');
                 btn.setAttribute('aria-selected', 'false');
             });
             
             // Find and activate the clicked button
             const activeButton = document.querySelector(`[aria-controls="${targetTabId}"]`);
             if (activeButton) {
                 activeButton.classList.add('active');
                 activeButton.setAttribute('aria-selected', 'true');
             }
             
             // Update tab contents
             tabContents.forEach(content => {
                 content.classList.remove('active');
             });
             
             // Show target content
             const targetContent = document.getElementById(targetTabId);
             if (targetContent) {
                 targetContent.classList.add('active');
                 console.log('Tab content activated:', targetTabId);
             } else {
                 console.error('Target content not found:', targetTabId);
             }
             
             // Update breadcrumb
             const breadcrumb = document.querySelector('.breadcrumb-item.active');
             if (breadcrumb && activeButton) {
                 const tabName = activeButton.textContent.trim();
                 breadcrumb.textContent = `Monitoring › ${tabName}`;
             }
             
             // Initialize tab-specific content
             if (targetTabId === 'tab-rs485') {
                 console.log('Initializing RS485 tab...');
                 initializeRs485Tab();
             }
         }
         
         function initializeTabSystem() {
             const tabButtons = document.querySelectorAll('.tab-item');
             const tabContents = document.querySelectorAll('.tab-content');
             
             console.log('Initializing tab system...');
             console.log('Found tab buttons:', tabButtons.length);
             console.log('Found tab contents:', tabContents.length);
             
             if (tabButtons.length === 0) {
                 console.error('No tab buttons found!');
                 return;
             }
             
             if (tabContents.length === 0) {
                 console.error('No tab contents found!');
                 return;
             }
             
             tabButtons.forEach((button, index) => {
                 console.log(`Setting up tab button ${index + 1}:`, button.textContent.trim());
                 
                 button.addEventListener('click', (event) => {
                     event.preventDefault();
                     console.log('Tab clicked:', button.textContent.trim());
                     
                     const targetTab = button.getAttribute('aria-controls');
                     console.log('Target tab:', targetTab);
                     
                     // Update tab buttons
                     tabButtons.forEach(btn => {
                         btn.classList.remove('active');
                         btn.setAttribute('aria-selected', 'false');
                     });
                     button.classList.add('active');
                     button.setAttribute('aria-selected', 'true');
                     
                     // Update tab contents
                     tabContents.forEach(content => {
                         content.classList.remove('active');
                     });
                     
                     const targetContent = document.getElementById(targetTab);
                     if (targetContent) {
                         targetContent.classList.add('active');
                         console.log('Tab content activated:', targetTab);
                     } else {
                         console.error('Target content not found:', targetTab);
                     }
                     
                     // Update breadcrumb
                     const breadcrumb = document.querySelector('.breadcrumb-item.active');
                     if (breadcrumb) {
                         const tabName = button.textContent.trim();
                         breadcrumb.textContent = `Monitoring › ${tabName}`;
                     }
                     
                     // Initialize tab-specific content
                     if (targetTab === 'tab-rs485') {
                         console.log('Initializing RS485 tab...');
                         initializeRs485Tab();
                     } else {
                         // Stop RS485 live updates when switching to other tabs
                         stopRs485LiveUpdates();
                     }
                     
                     // Visual feedback
                     button.style.transform = 'scale(0.95)';
                     setTimeout(() => {
                         button.style.transform = '';
                     }, 150);
                 });
             });
             
             console.log('Tab system initialization complete!');
         }
         
         // RS485 Tab Management
         function initializeRs485Tab() {
             console.log('Initializing RS485 tab with live updates...');
             
             // Initialize RS485 module grid
             renderRs485ModuleGrid();
             
             // Initialize RS485 event listeners
             document.getElementById('rs485-btn-scan')?.addEventListener('click', startRs485Discovery);
             document.getElementById('rs485-btn-restart')?.addEventListener('click', restartRs485Bus);
             document.getElementById('rs485-btn-add-module')?.addEventListener('click', showAddModuleDialog);
             
             // Update RS485 bus status
             updateRs485BusStatus();
             
            // Connect to RS485 WebSocket for real-time updates
            if (!rs485WS.isConnected) {
                rs485WS.connect();
                console.log('🔌 Connecting to RS485 WebSocket for real-time updates...');
            }
            
            // Start live updates for RS485 modules (fallback for when WebSocket is not available)
             startRs485LiveUpdates();
             
            console.log('RS485 tab initialized with WebSocket + API live updates');
         }
         
        async function renderRs485ModuleGrid() {
             const grid = document.getElementById('rs485-module-grid');
             if (!grid) return;
             
             grid.innerHTML = '';
             
            // Get modules from API or use cached data
            let modules;
            if (rs485ModulesData.length > 0) {
                modules = rs485ModulesData;
            } else {
                modules = await getRs485Modules();
                 rs485ModulesData = modules;
             }
             
             modules.forEach(module => {
                 const card = document.createElement('div');
                 card.className = 'module-card';
                 card.setAttribute('role', 'gridcell');
                 card.tabIndex = 0;
                 
                 const statusClass = getModuleStatusClass(module);
                 
                 card.innerHTML = `
                     <div class="module-card-header">
                         <div>
                             <div class="module-name">${module.name}</div>
                             <div class="module-address">${module.addr}</div>
                         </div>
                         <span class="module-status ${statusClass}" aria-live="polite">${module.status}</span>
                     </div>
                     <div class="module-badge ${module.mandatory ? 'mandatory' : 'optional'}">${module.mandatory ? 'Mandatory' : 'Optional'}</div>
                     <div class="module-metrics">
                         <div class="module-metric">
                             <span class="metric-label">Last Seen</span>
                             <span class="metric-value">${module.last_seen}</span>
                         </div>
                         <div class="module-metric">
                             <span class="metric-label">Error Rate</span>
                             <span class="metric-value">${module.error_rate}%</span>
                         </div>
                         <div class="module-metric">
                             <span class="metric-label">Response Time</span>
                             <span class="metric-value">${module.response_time}ms</span>
                         </div>
                         <div class="module-metric">
                             <span class="metric-label">FW Version</span>
                             <span class="metric-value">${module.fw_version}</span>
                         </div>
                     </div>
                 `;
                 
                 card.addEventListener('click', () => openRs485Detail(module));
                 card.addEventListener('keydown', (e) => {
                     if (e.key === 'Enter') openRs485Detail(module);
                 });
                 
                 grid.appendChild(card);
             });
         }
         
         function openRs485Detail(module) {
             const detailPanel = document.getElementById('rs485-detail-panel');
             const detailTitle = document.getElementById('detail-module-title');
             
             if (!detailPanel || !detailTitle) return;
             
             // Update detail panel title
             detailTitle.textContent = `${module.name} (${module.addr})`;
             
             // Update module status
             document.getElementById('detail-status').textContent = module.status;
             document.getElementById('detail-last-seen').textContent = module.last_seen;
             document.getElementById('detail-error-rate').textContent = `${module.error_rate}%`;
             document.getElementById('detail-response-time').textContent = `${module.response_time}ms`;
             
             // Update real-time values
             document.getElementById('detail-battery').textContent = `${module.real_time.battery}%`;
             document.getElementById('detail-voltage').textContent = `${module.real_time.voltage}V`;
             document.getElementById('detail-current').textContent = `${module.real_time.current}A`;
             document.getElementById('detail-temperature').textContent = `${module.real_time.temperature}°C`;
             
             // Show detail panel
             detailPanel.classList.remove('hidden');
             
             // Store current module for actions
             window.currentRs485Module = module;
         }
         
         function closeRs485Detail() {
             const detailPanel = document.getElementById('rs485-detail-panel');
             if (detailPanel) {
                 detailPanel.classList.add('hidden');
             }
             window.currentRs485Module = null;
         }
         
         // RS485 Module Actions
         function pingModule() {
             const module = window.currentRs485Module;
             if (!module) return;
             
             console.log(`Pinging module ${module.addr}...`);
             // TODO: Implement actual ping functionality
             
             // Show feedback
             const button = event.target.closest('.btn-detail-action');
             const originalText = button.innerHTML;
             button.innerHTML = '<i data-lucide="check" class="w-3 h-3" aria-hidden="true"></i> Pong!';
             button.style.background = 'var(--success-green)';
             
             setTimeout(() => {
                 button.innerHTML = originalText;
                 button.style.background = '';
             }, 2000);
         }
         
         function resetModule() {
             const module = window.currentRs485Module;
             if (!module) return;
             
             if (confirm(`Are you sure you want to reset module ${module.addr}?`)) {
                 console.log(`Resetting module ${module.addr}...`);
                 // TODO: Implement actual reset functionality
                 
                 // Show feedback
                 const button = event.target.closest('.btn-detail-action');
                 const originalText = button.innerHTML;
                 button.innerHTML = '<i data-lucide="refresh-cw" class="w-3 h-3" aria-hidden="true"></i> Resetting...';
                 button.disabled = true;
                 
                 setTimeout(() => {
                     button.innerHTML = originalText;
                     button.disabled = false;
                 }, 3000);
             }
         }
         
         function configureModule() {
             const module = window.currentRs485Module;
             if (!module) return;
             
             console.log(`Opening configuration for module ${module.addr}...`);
             // TODO: Implement configuration dialog
             alert(`Configuration dialog for ${module.addr} - Coming soon!`);
         }
         
         function quarantineModule() {
             const module = window.currentRs485Module;
             if (!module) return;
             
             if (confirm(`Are you sure you want to quarantine module ${module.addr}? This will disable all communication with this module.`)) {
                 console.log(`Quarantining module ${module.addr}...`);
                 // TODO: Implement actual quarantine functionality
                 
                 // Show feedback
                 const button = event.target.closest('.btn-detail-action');
                 const originalText = button.innerHTML;
                 button.innerHTML = '<i data-lucide="shield-check" class="w-3 h-3" aria-hidden="true"></i> Quarantined';
                 button.style.background = 'var(--warning-yellow)';
                 
                 setTimeout(() => {
                     button.innerHTML = originalText;
                     button.style.background = '';
                 }, 3000);
             }
         }
         
         // RS485 Bus Management
         function startRs485Discovery() {
             const scanButton = document.getElementById('rs485-btn-scan');
             if (!scanButton) return;
             
             scanButton.disabled = true;
             scanButton.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin" aria-hidden="true"></i> Scanning...';
             
             // Simulate discovery process
             setTimeout(() => {
                 scanButton.disabled = false;
                 scanButton.innerHTML = '<i data-lucide="search" class="w-4 h-4" aria-hidden="true"></i> Scan Now';
                 
                 // Update module grid with new data
                 renderRs485ModuleGrid();
                 
                 console.log('RS485 discovery completed');
             }, 3000);
         }
         
         function restartRs485Bus() {
             if (confirm('Are you sure you want to restart the RS485 bus? This will temporarily interrupt all module communication.')) {
                 console.log('Restarting RS485 bus...');
                 
                 const restartButton = document.getElementById('rs485-btn-restart');
                 if (restartButton) {
                     restartButton.disabled = true;
                     restartButton.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin" aria-hidden="true"></i> Restarting...';
                     
                     setTimeout(() => {
                         restartButton.disabled = false;
                         restartButton.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4" aria-hidden="true"></i> Restart Bus';
                         
                         // Update bus status
                         updateRs485BusStatus();
                         
                         console.log('RS485 bus restart completed');
                     }, 5000);
                 }
             }
         }
         
         function showAddModuleDialog() {
             // TODO: Implement add module dialog
             alert('Add Module Dialog - Coming soon!\n\nThis will allow you to:\n• Configure new module address\n• Set module type (Mandatory/Optional)\n• Define module parameters\n• Test module communication');
         }
         
         function updateRs485BusStatus() {
             const indicator = document.getElementById('rs485-bus-status-indicator');
             const statusText = document.getElementById('rs485-bus-status-text');
             
             if (!indicator || !statusText) return;
             
             // Simulate bus status
             const status = 'healthy'; // Could be 'healthy', 'warning', 'error'
             
             indicator.className = `bus-status-indicator ${status}`;
             statusText.textContent = status === 'healthy' ? 'Online' : 'Warning';
         }
         
         // Helper Functions
         function getModuleStatusClass(module) {
             if (module.status === 'healthy') return 'status-healthy';
             if (module.status === 'warning') return 'status-warning';
             if (module.status === 'error') return 'status-error';
             return 'status-lost';
         }
         
         // Global module data with live updates
         let rs485ModulesData = [];
         let rs485UpdateInterval = null;
         
        async function getRs485Modules() {
            try {
                const response = await rs485API.getModules();
                if (response.success && response.data) {
                    return response.data.map(module => ({
                        addr: module.addr,
                        name: module.name,
                        status: module.status,
                        last_seen: module.last_seen,
                        error_rate: module.error_rate,
                        response_time: module.response_time,
                        fw_version: module.fw_version,
                        mandatory: module.mandatory,
                        real_time: module.real_time
                    }));
                }
            } catch (error) {
                console.warn('🧪 Using mock RS485 modules due to API error:', error);
                return mockRs485ModulesFallback();
            }
        }
        
        function mockRs485ModulesFallback() {
             return [
                 {
                    addr: '0x02',
                     name: 'Power',
                     status: 'healthy',
                     last_seen: '2s ago',
                     error_rate: 0.02,
                     response_time: 45,
                     fw_version: 'v2.1.0',
                     mandatory: true,
                     real_time: {
                         battery: 85,
                         voltage: 24.2,
                         current: 2.1,
                         temperature: 42
                     }
                 },
                 {
                     addr: '0x02',
                     name: 'Safety',
                     status: 'warning',
                     last_seen: '5s ago',
                     error_rate: 2.1,
                     response_time: 78,
                     fw_version: 'v1.9.5',
                     mandatory: true,
                     real_time: {
                         battery: 92,
                         voltage: 24.0,
                         current: 1.8,
                         temperature: 38
                     }
                 },
                 {
                     addr: '0x03',
                     name: 'Travel',
                     status: 'healthy',
                     last_seen: '1s ago',
                     error_rate: 0.01,
                     response_time: 32,
                     fw_version: 'v2.0.1',
                     mandatory: true,
                     real_time: {
                         battery: 78,
                         voltage: 23.8,
                         current: 3.2,
                         temperature: 45
                     }
                 },
                 {
                     addr: '0x04',
                     name: 'Dock & Location',
                     status: 'healthy',
                     last_seen: '3s ago',
                     error_rate: 0.05,
                     response_time: 55,
                     fw_version: 'v1.8.2',
                     mandatory: true,
                     real_time: {
                         battery: 88,
                         voltage: 24.1,
                         current: 1.5,
                         temperature: 40
                     }
                 },
                 {
                     addr: '0x05',
                     name: 'Master',
                     status: 'healthy',
                     last_seen: '1s ago',
                     error_rate: 0.00,
                     response_time: 12,
                     fw_version: 'v2.2.0',
                     mandatory: true,
                     real_time: {
                         battery: 95,
                         voltage: 24.3,
                         current: 0.8,
                         temperature: 35
                     }
                 },
                 {
                     addr: '0x06',
                     name: 'Lifter',
                     status: 'healthy',
                     last_seen: '2s ago',
                     error_rate: 0.03,
                     response_time: 67,
                     fw_version: 'v1.7.8',
                     mandatory: false,
                     real_time: {
                         battery: 82,
                         voltage: 23.9,
                         current: 2.5,
                         temperature: 43
                     }
                 },
                 {
                     addr: '0x07',
                     name: 'Cargo',
                     status: 'healthy',
                     last_seen: '1s ago',
                     error_rate: 0.01,
                     response_time: 41,
                     fw_version: 'v1.9.0',
                     mandatory: false,
                     real_time: {
                         battery: 90,
                         voltage: 24.0,
                         current: 1.2,
                         temperature: 37
                     }
                 }
             ];
         }
         
         // Live update functions for RS485 modules
         function startRs485LiveUpdates() {
             console.log('Starting RS485 live updates...');
             
            // Initialize with real API data
            getRs485Modules().then(modules => {
                rs485ModulesData = modules;
            }).catch(error => {
                console.error('❌ Failed to initialize RS485 data:', error);
                rs485ModulesData = mockRs485ModulesFallback();
            });
            
            // Start update interval (every 5 seconds for API calls)
             rs485UpdateInterval = setInterval(() => {
                 updateRs485ModuleData();
            }, 5000);
             
            console.log('RS485 live updates started - updating every 5 seconds via API');
         }
         
         function stopRs485LiveUpdates() {
             if (rs485UpdateInterval) {
                 clearInterval(rs485UpdateInterval);
                 rs485UpdateInterval = null;
                 console.log('RS485 live updates stopped');
             }
         }
         
        async function updateRs485ModuleData() {
            try {
                // Get fresh data from API
                const freshModules = await getRs485Modules();
                if (freshModules && freshModules.length > 0) {
                    rs485ModulesData = freshModules;
                    console.log('✅ RS485 module data updated from API:', rs485ModulesData.length, 'modules');
                } else {
                    // Fallback to mock updates if API fails
                    console.warn('⚠️  API returned no data, using mock updates');
                    updateMockRs485Data();
                }
            } catch (error) {
                console.error('❌ Failed to update RS485 data from API:', error);
                // Fallback to mock updates
                updateMockRs485Data();
            }
            
            // Update UI if RS485 tab is active
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'tab-rs485') {
                updateRs485ModuleGrid();
                updateRs485DetailPanel();
            }
        }
        
        function updateMockRs485Data() {
            // Fallback mock updates when API is not available
             rs485ModulesData.forEach(module => {
                 // Update last_seen
                 const lastSeenSeconds = Math.floor(Math.random() * 5) + 1;
                 module.last_seen = `${lastSeenSeconds}s ago`;
                 
                 // Update real-time values with small variations
                if (module.real_time) {
                 module.real_time.battery = Math.max(10, Math.min(100, module.real_time.battery + (Math.random() - 0.5) * 2));
                 module.real_time.voltage = Math.max(20, Math.min(28, module.real_time.voltage + (Math.random() - 0.5) * 0.2));
                 module.real_time.current = Math.max(0.1, Math.min(5, module.real_time.current + (Math.random() - 0.5) * 0.1));
                 module.real_time.temperature = Math.max(20, Math.min(60, module.real_time.temperature + (Math.random() - 0.5) * 1));
                }
                 
                 // Update error rate and response time
                 module.error_rate = Math.max(0, Math.min(5, module.error_rate + (Math.random() - 0.5) * 0.1));
                 module.response_time = Math.max(10, Math.min(100, module.response_time + (Math.random() - 0.5) * 5));
                 
                // Occasionally change status (5% chance)
                if (Math.random() < 0.05) {
                     const statuses = ['healthy', 'warning', 'error'];
                     const currentIndex = statuses.indexOf(module.status);
                     const newIndex = (currentIndex + 1) % statuses.length;
                     module.status = statuses[newIndex];
                 }
             });
             
            console.log('🧪 RS485 module data updated with mock data:', rs485ModulesData.length, 'modules');
         }
         
         function updateRs485ModuleGrid() {
             const grid = document.getElementById('rs485-module-grid');
             if (!grid) return;
             
             // Update existing cards instead of recreating them
             const cards = grid.querySelectorAll('.module-card');
             cards.forEach((card, index) => {
                 const module = rs485ModulesData[index];
                 if (!module) return;
                 
                 // Update status
                 const statusElement = card.querySelector('.module-status');
                 if (statusElement) {
                     statusElement.className = `module-status ${getModuleStatusClass(module)}`;
                     statusElement.textContent = module.status;
                 }
                 
                 // Update metrics
                 const metrics = card.querySelectorAll('.metric-value');
                 if (metrics.length >= 4) {
                     metrics[0].textContent = module.last_seen;
                     metrics[1].textContent = `${module.error_rate.toFixed(2)}%`;
                     metrics[2].textContent = `${Math.round(module.response_time)}ms`;
                     metrics[3].textContent = module.fw_version;
                 }
             });
         }
         
         function updateRs485DetailPanel() {
             const detailPanel = document.getElementById('rs485-detail-panel');
             if (!detailPanel || detailPanel.classList.contains('hidden')) {
                 return;
             }
             
             const module = window.currentRs485Module;
             if (!module) return;
             
             // Find current module in updated data
             const updatedModule = rs485ModulesData.find(m => m.addr === module.addr);
             if (!updatedModule) return;
             
             // Update detail panel with new data
             document.getElementById('detail-status').textContent = updatedModule.status;
             document.getElementById('detail-last-seen').textContent = updatedModule.last_seen;
             document.getElementById('detail-error-rate').textContent = `${updatedModule.error_rate.toFixed(2)}%`;
             document.getElementById('detail-response-time').textContent = `${Math.round(updatedModule.response_time)}ms`;
             
             // Update real-time values
             document.getElementById('detail-battery').textContent = `${Math.round(updatedModule.real_time.battery)}%`;
             document.getElementById('detail-voltage').textContent = `${updatedModule.real_time.voltage.toFixed(1)}V`;
             document.getElementById('detail-current').textContent = `${updatedModule.real_time.current.toFixed(1)}A`;
             document.getElementById('detail-temperature').textContent = `${Math.round(updatedModule.real_time.temperature)}°C`;
             
             // Update current module reference
             window.currentRs485Module = updatedModule;
         }

         // Initialize monitoring when DOM is loaded
         document.addEventListener('DOMContentLoaded', () => {
             // Initialize Lucide icons first
             if (typeof lucide !== 'undefined') {
                 lucide.createIcons();
             }
             
             // Initialize tab system FIRST (before other controllers)
             initializeTabSystem();
             
             // Initialize monitoring controller with error handling
             try {
                 new MonitoringController();
             } catch (error) {
                 console.warn('MonitoringController initialization warning:', error);
             }
             
             // Initialize RS485 Event Listeners
             document.getElementById('btn-scan')?.addEventListener('click', startDiscovery);
             document.getElementById('btn-restart')?.addEventListener('click', () => {
                 console.log('Restart RS485 Bus');
                 startDiscovery();
             });
             
             // Initialize alert filters
             initializeAlertFilters();
             updateAlertCount();
            
            // Initialize RS485 WebSocket (for real-time updates)
            console.log('🔌 Initializing RS485 WebSocket...');
            rs485WS.connect();
             
             // Debug: Test tab functionality
             console.log('Tab system initialized. Testing tab switching...');
             
             // Add debug event listeners to verify tab buttons exist
             const tabButtons = document.querySelectorAll('.tab-item');
             console.log(`Found ${tabButtons.length} tab buttons:`, tabButtons);
             
             tabButtons.forEach((btn, index) => {
                 btn.addEventListener('click', () => {
                     console.log(`Tab ${index + 1} clicked:`, btn.textContent.trim());
                 });
             });
         });

        // 🎯 Telemetry Table Functions
        
        /**
         * Filter telemetry table by search text
         */
        function filterTelemetryTable() {
            const searchText = document.getElementById('telemetry-search').value.toLowerCase();
            const rows = document.querySelectorAll('#telemetry-table-body tr');
            
            let visibleCount = 0;
            rows.forEach(row => {
                const address = row.querySelector('.address-cell').textContent.toLowerCase();
                const name = row.cells[1].textContent.toLowerCase();
                const shouldShow = address.includes(searchText) || name.includes(searchText);
                
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            updateTelemetryStats(visibleCount);
        }

        /**
         * Filter telemetry table by mode (R, RW)
         */
        function filterTelemetryByMode() {
            const selectedMode = document.getElementById('telemetry-mode-filter').value;
            const rows = document.querySelectorAll('#telemetry-table-body tr');
            
            let visibleCount = 0;
            rows.forEach(row => {
                const mode = row.dataset.mode;
                const shouldShow = selectedMode === 'all' || mode === selectedMode;
                
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            updateTelemetryStats(visibleCount);
        }

        /**
         * Update telemetry statistics display
         */
        function updateTelemetryStats(visibleCount = null) {
            const allRows = document.querySelectorAll('#telemetry-table-body tr');
            const readOnlyRows = document.querySelectorAll('#telemetry-table-body tr[data-mode="r"]');
            const writableRows = document.querySelectorAll('#telemetry-table-body tr[data-mode="rw"]');
            
            const total = visibleCount !== null ? visibleCount : allRows.length;
            const readOnly = readOnlyRows.length;
            const writable = writableRows.length;
            
            document.getElementById('telemetry-stats').textContent = 
                `${total} registers ${visibleCount !== null ? 'shown' : 'total'} • ${readOnly} read-only • ${writable} writable`;
        }

        /**
         * Write value to register (RW mode)
         */
        function writeRegister(address, value) {
            console.log(`Writing register ${address} = ${value}`);
            
            // Simulate API call to backend
            const writeData = {
                address: address,
                value: parseInt(value),
                timestamp: new Date().toISOString()
            };
            
            // Show loading state
            const input = event.target;
            input.disabled = true;
            input.style.opacity = '0.6';
            
            // Simulate API call
            setTimeout(() => {
                input.disabled = false;
                input.style.opacity = '1';
                
                // Flash success
                const cell = input.closest('.value-cell');
                cell.classList.add('updated');
                setTimeout(() => cell.classList.remove('updated'), 800);
                
                console.log('Register write successful:', writeData);
                
                // Update via WebSocket if available
                if (rs485WS && rs485WS.isConnected) {
                    rs485WS.sendMessage({
                        type: 'write_register',
                        data: writeData
                    });
                }
            }, 500);
        }

        /**
         * Update telemetry table with real-time data
         */
        function updateTelemetryTable(telemetryData) {
            if (!telemetryData || !telemetryData.registers) return;
            
            Object.keys(telemetryData.registers).forEach(registerName => {
                const value = telemetryData.registers[registerName];
                const cell = document.querySelector(`[data-register="${registerName}"]`);
                
                if (cell && !cell.querySelector('input')) {
                    const oldValue = cell.textContent;
                    const newValue = value.toString();
                    
                    if (oldValue !== newValue) {
                        cell.textContent = newValue;
                        cell.classList.add('updated');
                        setTimeout(() => cell.classList.remove('updated'), 800);
                    }
                }
            });
            
            // Update last update time
            document.getElementById('last-update-time').textContent = '0s ago';
        }

        /**
         * Export telemetry data to CSV
         */
        function exportTelemetryCSV() {
            const table = document.getElementById('telemetry-registers-table');
            const rows = table.querySelectorAll('tr');
            
            let csvContent = '';
            
            // Header
            const headers = Array.from(rows[0].cells).map(cell => cell.textContent.trim());
            csvContent += headers.join(',') + '\\n';
            
            // Data rows
            for (let i = 1; i < rows.length; i++) {
                if (rows[i].style.display !== 'none') {
                    const cells = Array.from(rows[i].cells);
                    const rowData = cells.map(cell => {
                        const input = cell.querySelector('input');
                        return input ? input.value : cell.textContent.trim();
                    });
                    csvContent += rowData.join(',') + '\\n';
                }
            }
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `telemetry_registers_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            console.log('Telemetry CSV exported');
        }

        /**
         * Export telemetry data to Excel format
         */
        function exportTelemetryExcel() {
            // This would require a library like SheetJS for full Excel support
            // For now, export as CSV with .xlsx extension
            exportTelemetryCSV();
            console.log('Telemetry Excel export (as CSV)');
        }

        // 🔌 Extend RS485WebSocketClient for telemetry
        if (typeof RS485WebSocketClient !== 'undefined') {
            const originalHandleMessage = RS485WebSocketClient.prototype.handleMessage;
            
            RS485WebSocketClient.prototype.handleMessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Handle telemetry updates
                if (data.type === 'telemetry_update' || data.type === 'register_data') {
                    updateTelemetryTable(data);
                    return;
                }
                
                // Call original handler for other message types
                if (originalHandleMessage) {
                    originalHandleMessage.call(this, event);
                }
            };
        }

        // 🕒 Auto-update last update time
        setInterval(() => {
            const lastUpdateElement = document.getElementById('last-update-time');
            if (lastUpdateElement) {
                const currentText = lastUpdateElement.textContent;
                if (currentText.includes('s ago')) {
                    const seconds = parseInt(currentText) + 1;
                    lastUpdateElement.textContent = `${seconds}s ago`;
                }
            }
        }, 1000);

        // 🔧 Debug function to test telemetry tab
        function debugTelemetryTab() {
            console.log('🔍 Debug Telemetry Tab:');
            
            const telemetryTab = document.getElementById('telemetry-tab');
            const telemetryButton = document.querySelector('.modal-tab[onclick*="telemetry"]');
            
            console.log('Telemetry tab element:', telemetryTab);
            console.log('Telemetry button:', telemetryButton);
            console.log('Tab classes:', telemetryTab?.className);
            console.log('Tab display style:', telemetryTab?.style.display);
            console.log('Tab computed style:', window.getComputedStyle(telemetryTab)?.display);
            
            // Force show telemetry tab for testing
            if (telemetryTab) {
                telemetryTab.classList.add('active');
                telemetryTab.style.display = 'block';
                console.log('✅ Forced telemetry tab to show');
            }
        }

        // 💪 FORCE FIX: Guaranteed modal show function
        function forceShowModal(addr = 1) {
            console.log('💪 FORCE: Force showing modal for address:', addr);
            
            const modal = document.getElementById('module-detail-modal');
            if (!modal) {
                console.error('❌ FORCE: Modal element not found!');
                return;
            }
            
            // Force show modal immediately
            modal.style.display = 'flex';
            modal.setAttribute('open', '');
            modal.style.zIndex = '9999';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            console.log('💪 FORCE: Modal force-shown!');
            
            // Force populate data
            const module = mockModules().find(m => m.addr === addr);
            if (module) {
                document.getElementById('module-modal-title').textContent = `Module [0x${addr.toString(16).padStart(2,'0').toUpperCase()}]`;
                document.getElementById('modal-module-name').textContent = module.name;
                document.getElementById('modal-module-addr').textContent = `0x${addr.toString(16).padStart(2,'0').toUpperCase()}`;
                document.getElementById('modal-module-type').textContent = module.mandatory ? 'Mandatory' : 'Optional';
                document.getElementById('modal-module-fw').textContent = module.fw_version;
                document.getElementById('modal-module-status').textContent = module.health.toUpperCase();
                document.getElementById('modal-module-last-seen').textContent = module.last_seen;
                document.getElementById('modal-module-error-rate').textContent = `${(module.error_rate*100).toFixed(2)}%`;
                document.getElementById('modal-module-response-p95').textContent = `${module.response_time_p95} ms`;
                console.log('💪 FORCE: Modal data populated!');
            }
            
            // Force show telemetry tab
            setTimeout(() => {
                showTelemetryTab();
                console.log('💪 FORCE: Telemetry tab shown!');
            }, 500);
        }

        // 🎯 SIMPLE TELEMETRY TAB FUNCTION - NO COMPLICATIONS
        function showTelemetryTab() {
            console.log('🎯 SIMPLE: Showing telemetry tab');
            
            // Step 1: Hide ALL tabs
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Step 2: Remove active from ALL buttons
            const allButtons = document.querySelectorAll('.modal-tab');
            allButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Step 3: Show ONLY telemetry tab
            const telemetryTab = document.getElementById('telemetry-tab');
            const telemetryBtn = document.getElementById('telemetry-tab-btn');
            
            if (telemetryTab && telemetryBtn) {
                telemetryTab.style.display = 'block';
                telemetryTab.classList.add('active');
                telemetryBtn.classList.add('active');
                console.log('✅ SIMPLE: Telemetry tab shown!');
            } else {
                console.error('❌ SIMPLE: Elements not found');
            }
        }

        // 🚀 Emergency fix: Force telemetry tab to work
        function forceTelemetryTab() {
            console.log('🚑 Emergency telemetry tab fix...');
            
            const telemetryTab = document.getElementById('telemetry-tab');
            const telemetryButton = document.getElementById('telemetry-tab-btn');
            
            if (telemetryTab && telemetryButton) {
                // Remove existing onclick and add new one
                telemetryButton.removeAttribute('onclick');
                telemetryButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🔄 Telemetry button clicked - emergency handler!');
                    
                    // Hide all tabs
                    document.querySelectorAll('.tab-content').forEach(tab => {
                        tab.classList.remove('active');
                        tab.style.display = 'none';
                    });
                    
                    // Remove active from all buttons
                    document.querySelectorAll('.modal-tab').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Show telemetry tab
                    telemetryTab.classList.add('active');
                    telemetryTab.style.display = 'block';
                    telemetryButton.classList.add('active');
                    
                    console.log('✅ Telemetry tab forced to show!');
                });
                
                console.log('✅ Emergency handler attached');
            }
        }

        // 🧪 TEST FUNCTION - Call this in console
        function testTelemetryTab() {
            console.log('🧪 TESTING telemetry tab...');
            
            // First open a modal
            console.log('1. Opening modal...');
            openModuleDetail(0x01);
            
            // Wait then try to show telemetry
            setTimeout(() => {
                console.log('2. Showing telemetry tab...');
                showTelemetryTab();
                
                // Check result
                setTimeout(() => {
                    const telemetryTab = document.getElementById('telemetry-tab');
                    const isVisible = telemetryTab && window.getComputedStyle(telemetryTab).display !== 'none';
                    console.log('3. Test result:', isVisible ? '✅ SUCCESS' : '❌ FAILED');
                }, 500);
            }, 500);
        }

        // 🧪 TEST FUNCTION - Force render modules and test modal
        function testModulesAndModal() {
            console.log('🧪 TESTING modules and modal...');
            
            // Step 1: Check if grid exists
            const grid = document.getElementById('rs485-module-grid');
            console.log('1. Grid element:', grid);
            
            // Step 2: Force render modules
            console.log('2. Force rendering modules...');
            const testModules = mockModules();
            console.log('   Mock modules:', testModules);
            renderModuleGrid(testModules);
            
            // Step 3: Test modal opening
            setTimeout(() => {
                console.log('3. Testing modal opening...');
                openModuleDetail(0x01);
                
                // Check if modal opened
                setTimeout(() => {
                    const modal = document.getElementById('module-detail-modal');
                    const isOpen = modal && modal.hasAttribute('open');
                    console.log('4. Modal test result:', isOpen ? '✅ SUCCESS' : '❌ FAILED');
                }, 500);
            }, 1000);
        }

        // 🎯 API Toggle Function
        function toggleAPI() {
            window.USE_REAL_API = !USE_REAL_API;
            console.log('🔄 API Mode changed to:', USE_REAL_API ? 'REAL API' : 'MOCK DATA');
            
            // Re-render modules with new mode
            setTimeout(() => {
                console.log('🔄 Re-rendering modules...');
                tick(); // Trigger a refresh
            }, 500);
        }

        // 🔧 Initialize telemetry tab on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Page loaded - FORCE FIX MODE ACTIVE!');
            console.log('💡 API Mode:', USE_REAL_API ? 'REAL API (will show CORS errors)' : 'MOCK DATA (no errors)');
            console.log('💪 FORCE COMMANDS:');
            console.log('   forceShowModal() - Force show modal immediately');
            console.log('   forceRenderModules() - Force render modules');
            console.log('   testModulesAndModal() - Full test');
            console.log('💡 NORMAL COMMANDS:');
            console.log('   toggleAPI() - Toggle API mode');
            console.log('   testTelemetryTab() - Test telemetry');
            
            // Make test functions global for console access
            window.testTelemetryTab = testTelemetryTab;
            window.testModulesAndModal = testModulesAndModal;
            window.showTelemetryTab = showTelemetryTab;
            window.openModuleDetail = openModuleDetail;
            window.renderModuleGrid = renderModuleGrid;
            window.toggleAPI = toggleAPI;
            window.USE_REAL_API = USE_REAL_API; // Make it global
            
            // 💪 FORCE FIX: Global force functions
            window.forceShowModal = forceShowModal;
            window.mockModules = mockModules;
            window.forceRenderModules = () => {
                console.log('💪 FORCE: Manual module render');
                const modules = mockModules();
                renderModuleGrid(modules);
            };
            
            // 💪 FORCE FIX: Immediate module rendering
            console.log('💪 FORCE: Immediate module rendering...');
            try {
                const modules = mockModules();
                console.log('💪 FORCE: Modules data:', modules);
                renderModuleGrid(modules);
                console.log('💪 FORCE: Modules rendered successfully!');
            } catch (error) {
                console.error('❌ FORCE: Auto-render failed:', error);
            }
            
            // Backup: Try again after 1 second
            setTimeout(() => {
                console.log('💪 FORCE: Backup render attempt...');
                try {
                    const modules = mockModules();
                    renderModuleGrid(modules);
                } catch (error) {
                    console.error('❌ FORCE: Backup render failed:', error);
                }
            }, 1000);
        });

    </script>
</body>
</html>
