<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS485 API Integration Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold; 
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .test-section h3 { 
            margin-top: 0; 
            color: #333; 
        }
        
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .module-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .module-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .module-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-healthy { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-lost { background: #e2e3e5; color: #6c757d; }
        
        .module-details {
            font-size: 14px;
            color: #6c757d;
        }
        
        .module-details div {
            margin: 5px 0;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå RS485 API Integration Test</h1>
        <p>Test c√°c API endpoints cho RS485 modules management</p>
        
        <div class="status info" id="connection-status">
            üì° ƒêang ki·ªÉm tra k·∫øt n·ªëi ƒë·∫øn backend...
        </div>
        
        <!-- Test API Health -->
        <div class="test-section">
            <h3>üè• API Health Check</h3>
            <button class="btn-primary" onclick="testApiHealth()">Test Backend Connection</button>
            <div id="health-result"></div>
        </div>
        
        <!-- Test RS485 Modules -->
        <div class="test-section">
            <h3>üì° RS485 Modules</h3>
            <button class="btn-primary" onclick="testGetModules()">Get All Modules</button>
            <button class="btn-success" onclick="testGetModule(2)">Get Power Module (0x02)</button>
            <div id="modules-result"></div>
            <div id="modules-grid" class="module-grid"></div>
        </div>
        
        <!-- Test Bus Health -->
        <div class="test-section">
            <h3>üöå RS485 Bus Health</h3>
            <button class="btn-primary" onclick="testBusHealth()">Get Bus Health</button>
            <button class="btn-warning" onclick="testRestartBus()">Restart Bus</button>
            <div id="bus-result"></div>
        </div>
        
        <!-- Test Discovery -->
        <div class="test-section">
            <h3>üîç Module Discovery</h3>
            <button class="btn-primary" onclick="testStartDiscovery()">Start Discovery</button>
            <button class="btn-success" onclick="testDiscoveryStatus()">Get Status</button>
            <button class="btn-success" onclick="testDiscoveryResults()">Get Results</button>
            <div id="discovery-result"></div>
        </div>
        
        <!-- Test Module Actions -->
        <div class="test-section">
            <h3>‚ö° Module Actions</h3>
            <button class="btn-success" onclick="testPingModule(2)">Ping Power Module</button>
            <button class="btn-warning" onclick="testResetModule(3)">Reset Safety Module</button>
            <div id="actions-result"></div>
        </div>
        
        <!-- Raw API Response -->
        <div class="test-section">
            <h3>üìÑ Raw API Response</h3>
            <pre id="raw-response">Ch∆∞a c√≥ d·ªØ li·ªáu...</pre>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api/v1/rs485';
        const TOKEN = 'demo-token';
        
        // Check API connection on load
        window.addEventListener('load', () => {
            testApiHealth();
        });
        
        async function makeApiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${TOKEN}`
                }
            };
            
            const requestOptions = { ...defaultOptions, ...options };
            
            try {
                console.log(`üîå API Call: ${options.method || 'GET'} ${url}`);
                const response = await fetch(url, requestOptions);
                
                const data = await response.json();
                console.log(`‚úÖ API Response:`, data);
                
                document.getElementById('raw-response').textContent = JSON.stringify(data, null, 2);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return { success: true, data, status: response.status };
            } catch (error) {
                console.error(`‚ùå API Error:`, error);
                document.getElementById('raw-response').textContent = `Error: ${error.message}`;
                return { success: false, error: error.message };
            }
        }
        
        async function testApiHealth() {
            const statusEl = document.getElementById('connection-status');
            const resultEl = document.getElementById('health-result');
            
            statusEl.innerHTML = 'üì° <span class="loading"></span> ƒêang ki·ªÉm tra k·∫øt n·ªëi...';
            
            const result = await makeApiCall('/health');
            
            if (result.success) {
                statusEl.className = 'status success';
                statusEl.innerHTML = '‚úÖ K·∫øt n·ªëi backend th√†nh c√¥ng!';
                resultEl.innerHTML = `
                    <div class="status success">
                        ‚úÖ Backend API ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng<br>
                        üìä Health Score: ${result.data.data?.health_score || 'N/A'}%<br>
                        üì° Total Modules: ${result.data.data?.total_modules || 'N/A'}<br>
                        üü¢ Healthy: ${result.data.data?.healthy_modules || 'N/A'}<br>
                        üü° Warning: ${result.data.data?.warning_modules || 'N/A'}<br>
                        üî¥ Error: ${result.data.data?.error_modules || 'N/A'}
                    </div>
                `;
            } else {
                statusEl.className = 'status error';
                statusEl.innerHTML = '‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn backend!';
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
        
        async function testGetModules() {
            const resultEl = document.getElementById('modules-result');
            const gridEl = document.getElementById('modules-grid');
            
            resultEl.innerHTML = '<div class="loading"></div> ƒêang l·∫•y danh s√°ch modules...';
            
            const result = await makeApiCall('/modules');
            
            if (result.success && result.data.data) {
                const modules = result.data.data;
                resultEl.innerHTML = `<div class="status success">‚úÖ T√¨m th·∫•y ${modules.length} RS485 modules</div>`;
                
                // Render modules grid
                gridEl.innerHTML = modules.map(module => `
                    <div class="module-card">
                        <div class="module-header">
                            <div class="module-name">${module.name}</div>
                            <div class="module-status status-${module.status}">${module.status}</div>
                        </div>
                        <div class="module-details">
                            <div><strong>Address:</strong> ${module.addr}</div>
                            <div><strong>Type:</strong> ${module.mandatory ? 'Mandatory' : 'Optional'}</div>
                            <div><strong>Last Seen:</strong> ${module.last_seen}</div>
                            <div><strong>Error Rate:</strong> ${module.error_rate.toFixed(2)}%</div>
                            <div><strong>Response Time:</strong> ${module.response_time}ms</div>
                            <div><strong>FW Version:</strong> ${module.fw_version}</div>
                            <div><strong>Battery:</strong> ${module.real_time.battery.toFixed(1)}%</div>
                            <div><strong>Temperature:</strong> ${module.real_time.temperature.toFixed(1)}¬∞C</div>
                        </div>
                    </div>
                `).join('');
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
                gridEl.innerHTML = '';
            }
        }
        
        async function testGetModule(address) {
            const resultEl = document.getElementById('modules-result');
            
            resultEl.innerHTML = `<div class="loading"></div> ƒêang l·∫•y th√¥ng tin module 0x${address.toString(16).padStart(2,'0').toUpperCase()}...`;
            
            const result = await makeApiCall(`/modules/${address}`);
            
            if (result.success && result.data.data) {
                const module = result.data.data;
                resultEl.innerHTML = `
                    <div class="status success">
                        ‚úÖ Module ${module.name} (${module.addr})<br>
                        üìä Status: ${module.status}<br>
                        üîã Battery: ${module.real_time.battery.toFixed(1)}%<br>
                        üå°Ô∏è Temperature: ${module.real_time.temperature.toFixed(1)}¬∞C<br>
                        ‚ö° Voltage: ${module.real_time.voltage.toFixed(1)}V<br>
                        üì° Last Seen: ${module.last_seen}
                    </div>
                `;
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
        
        async function testBusHealth() {
            const resultEl = document.getElementById('bus-result');
            
            resultEl.innerHTML = '<div class="loading"></div> ƒêang ki·ªÉm tra RS485 bus health...';
            
            const result = await makeApiCall('/bus/health');
            
            if (result.success && result.data.data) {
                const bus = result.data.data;
                resultEl.innerHTML = `
                    <div class="status success">
                        ‚úÖ RS485 Bus Health<br>
                        üìä Status: ${bus.status}<br>
                        üìà Error Rate: ${bus.error_rate.toFixed(2)}%<br>
                        ‚è±Ô∏è Response P95: ${bus.response_time_p95}ms<br>
                        üöÄ Throughput: ${bus.throughput} fps<br>
                        üì° Total Modules: ${bus.total_modules}<br>
                        üü¢ Active: ${bus.active_modules}<br>
                        üî¥ Failed: ${bus.failed_modules}
                    </div>
                `;
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
        
        async function testRestartBus() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën restart RS485 bus kh√¥ng?')) return;
            
            const resultEl = document.getElementById('bus-result');
            
            resultEl.innerHTML = '<div class="loading"></div> ƒêang restart RS485 bus...';
            
            const result = await makeApiCall('/bus/restart', {
                method: 'POST',
                body: JSON.stringify({ action: 'restart', force: false })
            });
            
            if (result.success) {
                resultEl.innerHTML = `<div class="status success">‚úÖ ${result.data.message}</div>`;
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
        
        async function testStartDiscovery() {
            const resultEl = document.getElementById('discovery-result');
            
            resultEl.innerHTML = '<div class="loading"></div> ƒêang b·∫Øt ƒë·∫ßu discovery...';
            
            const result = await makeApiCall('/discovery/start', { method: 'POST' });
            
            if (result.success && result.data.data) {
                const discovery = result.data.data;
                resultEl.innerHTML = `
                    <div class="status info">
                        üîç Discovery Started<br>
                        üìä Status: ${discovery.status_message}<br>
                        üìà Progress: ${discovery.progress}%<br>
                        üì° Modules Found: ${discovery.modules_found}
                    </div>
                `;
                
                // Auto-update status
                setTimeout(() => testDiscoveryStatus(), 2000);
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
        
        async function testDiscoveryStatus() {
            const resultEl = document.getElementById('discovery-result');
            
            const result = await makeApiCall('/discovery/status');
            
            if (result.success && result.data.data) {
                const discovery = result.data.data;
                const statusClass = discovery.is_running ? 'info' : 'success';
                resultEl.innerHTML = `
                    <div class="status ${statusClass}">
                        üîç Discovery Status<br>
                        üìä Status: ${discovery.status_message}<br>
                        üìà Progress: ${discovery.progress}%<br>
                        üì° Modules Found: ${discovery.modules_found}<br>
                        ‚ö†Ô∏è Conflicts: ${discovery.conflicts.length}
                    </div>
                `;
                
                if (discovery.is_running) {
                    setTimeout(() => testDiscoveryStatus(), 1000);
                }
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
        
        async function testDiscoveryResults() {
            const resultEl = document.getElementById('discovery-result');
            
            const result = await makeApiCall('/discovery/results');
            
            if (result.success && result.data.data) {
                const results = result.data.data;
                resultEl.innerHTML = `
                    <div class="status success">
                        ‚úÖ Discovery Results (${results.length} modules)<br>
                        ${results.map(r => `üì° ${r.addr} - ${r.name} ${r.found ? '‚úÖ' : '‚ùå'} ${r.conflict ? '‚ö†Ô∏è' : ''}`).join('<br>')}
                    </div>
                `;
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
        
        async function testPingModule(address) {
            const resultEl = document.getElementById('actions-result');
            
            resultEl.innerHTML = `<div class="loading"></div> ƒêang ping module 0x${address.toString(16).padStart(2,'0').toUpperCase()}...`;
            
            const result = await makeApiCall(`/modules/${address}/ping`, { method: 'POST' });
            
            if (result.success && result.data.data) {
                resultEl.innerHTML = `
                    <div class="status success">
                        ‚úÖ Ping Successful<br>
                        üì® Message: ${result.data.data.message}<br>
                        ‚è±Ô∏è Response Time: ${result.data.data.response_time}ms
                    </div>
                `;
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
        
        async function testResetModule(address) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën reset module 0x${address.toString(16).padStart(2,'0').toUpperCase()} kh√¥ng?`)) return;
            
            const resultEl = document.getElementById('actions-result');
            
            resultEl.innerHTML = `<div class="loading"></div> ƒêang reset module 0x${address.toString(16).padStart(2,'0').toUpperCase()}...`;
            
            const result = await makeApiCall(`/modules/${address}/reset`, { method: 'POST' });
            
            if (result.success) {
                resultEl.innerHTML = `<div class="status success">‚úÖ ${result.data.message}</div>`;
            } else {
                resultEl.innerHTML = `<div class="status error">‚ùå ${result.error}</div>`;
            }
        }
    </script>
</body>
</html>
