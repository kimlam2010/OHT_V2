{
  "title": "🐛 [BUG] WiFi AP Stop API không kill hostapd/dnsmasq processes",
  "body": "## 🐛 MÔ TẢ LỖI\n\n**API endpoint:** `POST /api/v1/network/ap/stop`\n\n**Vấn đề:** API trả về `success: true` nhưng **hostapd** và **dnsmasq** processes vẫn chạy.\n\n---\n\n## 📋 THÔNG TIN CHI TIẾT\n\n### ✅ API Response:\n```json\n{\n  \"success\": true,\n  \"message\": \"WiFi AP stopped successfully\",\n  \"timestamp\": \"2025-10-07T10:18:10Z\"\n}\n```\n\n### ❌ Thực tế:\n```bash\nps aux | grep hostapd\nroot  68910  hostapd -B /tmp/hostapd.conf -P /tmp/hostapd.pid\n\nps aux | grep dnsmasq  \nnobody  70478  dnsmasq -C /tmp/dnsmasq.conf\n```\n\n**Kết luận:** API internal state đúng (`ap_enabled = false`) nhưng **HAL không kill processes thật**.\n\n---\n\n## 🔍 ROOT CAUSE ANALYSIS\n\n### File liên quan:\n- `firmware_new/src/hal/communication/hal_wifi_ap.c`\n- Function: `hal_wifi_ap_stop()`\n\n### Nghi ngờ:\n1. ❌ PID file path sai\n2. ❌ Process kill command thất bại  \n3. ❌ Không đợi process terminate\n4. ❌ Không cleanup PID files\n\n---\n\n## 🔄 STEPS TO REPRODUCE\n\n### 1. Start WiFi AP\n### 2. Verify processes running  \n### 3. Call stop API\n### 4. Verify processes STILL RUNNING (bug!)\n\n---\n\n## 💡 ĐỀ XUẤT FIX\n\n### Option 1: Properly kill with timeout\n```c\nstatic int stop_hostapd(void) {\n    pid_t pid = read_pid_from_file(\"/tmp/hostapd.pid\");\n    if (pid > 0) {\n        kill(pid, SIGTERM);\n        wait_for_termination(pid, 5);  // 5 sec timeout\n        if (is_process_running(pid)) {\n            kill(pid, SIGKILL);  // Force kill\n        }\n        unlink(\"/tmp/hostapd.pid\");  // Cleanup\n    }\n    return HAL_STATUS_OK;\n}\n```\n\n### Option 2: Use pkill\n```c\nsystem(\"pkill -f hostapd\");\nsystem(\"pkill -f 'dnsmasq.*wlan0'\");\n```\n\n---\n\n## 📊 IMPACT\n\n### Severity: 🔴 **HIGH**\n\n**Lý do:**\n- 🔴 Security risk: Zombie processes\n- 🔴 Resource leak: WiFi interface locked  \n- 🔴 Cannot restart AP\n- 🔴 User confusion: UI shows stopped but AP still broadcasting\n\n### Workaround:\n```bash\nsudo pkill hostapd\nsudo pkill dnsmasq\n```\n\n---\n\n## ✅ CHECKLIST FIX\n\n- [ ] Fix `hal_wifi_ap_stop()` to kill processes\n- [ ] Add process verification\n- [ ] Add timeout and SIGKILL fallback\n- [ ] Cleanup PID files\n- [ ] Unit tests\n- [ ] Integration tests\n\n---\n\n## 📝 ENVIRONMENT\n\n- Platform: Orange Pi 5B (RK3588)\n- OS: Ubuntu 22.04  \n- Firmware: current master\n- Date: 2025-10-07\n\n---\n\n**Priority:** 🔥 High  \n**Component:** Firmware/HAL",
  "labels": ["bug", "firmware", "hal", "high-priority"]
}

