<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS485 API Integration Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold; 
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .test-section h3 { 
            margin-top: 0; 
            color: #333; 
        }
        
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .module-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .module-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .module-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-healthy { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-lost { background: #e2e3e5; color: #6c757d; }
        
        .module-details {
            font-size: 14px;
            color: #6c757d;
        }
        
        .module-details div {
            margin: 5px 0;
        }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”Œ RS485 API Integration Test</h1>
        <p>Test cÃ¡c API endpoints cho RS485 modules management</p>
        
        <div class="status info" id="connection-status">
            ğŸ“¡ Äang kiá»ƒm tra káº¿t ná»‘i Ä‘áº¿n backend...
        </div>
        
        <!-- Test API Health -->
        <div class="test-section">
            <h3>ğŸ¥ API Health Check</h3>
            <button class="btn-primary" onclick="testApiHealth()">Test Backend Connection</button>
            <div id="health-result"></div>
        </div>
        
        <!-- Test RS485 Modules -->
        <div class="test-section">
            <h3>ğŸ“¡ RS485 Modules</h3>
            <button class="btn-primary" onclick="testGetModules()">Get All Modules</button>
            <button class="btn-success" onclick="testGetModule(2)">Get Power Module (0x02)</button>
            <div id="modules-result"></div>
            <div id="modules-grid" class="module-grid"></div>
        </div>
        
        <!-- Test Bus Health -->
        <div class="test-section">
            <h3>ğŸšŒ RS485 Bus Health</h3>
            <button class="btn-primary" onclick="testBusHealth()">Get Bus Health</button>
            <button class="btn-warning" onclick="testRestartBus()">Restart Bus</button>
            <div id="bus-result"></div>
        </div>
        
        <!-- Test Discovery -->
        <div class="test-section">
            <h3>ğŸ” Module Discovery</h3>
            <button class="btn-primary" onclick="testStartDiscovery()">Start Discovery</button>
            <button class="btn-success" onclick="testDiscoveryStatus()">Get Status</button>
            <button class="btn-success" onclick="testDiscoveryResults()">Get Results</button>
            <div id="discovery-result"></div>
        </div>
        
        <!-- Test Module Actions -->
        <div class="test-section">
            <h3>âš¡ Module Actions</h3>
            <button class="btn-success" onclick="testPingModule(2)">Ping Power Module</button>
            <button class="btn-warning" onclick="testResetModule(3)">Reset Safety Module</button>
            <div id="actions-result"></div>
        </div>
        
        <!-- Raw API Response -->
        <div class="test-section">
            <h3>ğŸ“„ Raw API Response</h3>
            <pre id="raw-response">ChÆ°a cÃ³ dá»¯ liá»‡u...</pre>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api/v1/rs485';
        const TOKEN = 'demo-token';
        
        // Check API connection on load
        window.addEventListener('load', () => {
            testApiHealth();
        });
        
        async function makeApiCall(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${TOKEN}`
                }
            };
            
            const requestOptions = { ...defaultOptions, ...options };
            
            try {
                console.log(`ğŸ”Œ API Call: ${options.method || 'GET'} ${url}`);
                const response = await fetch(url, requestOptions);
                
                const data = await response.json();
                console.log(`âœ… API Response:`, data);
                
                document.getElementById('raw-response').textContent = JSON.stringify(data, null, 2);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return { success: true, data, status: response.status };
            } catch (error) {
                console.error(`âŒ API Error:`, error);
                document.getElementById('raw-response').textContent = `Error: ${error.message}`;
                return { success: false, error: error.message };
            }
        }
        
        async function testApiHealth() {
            const statusEl = document.getElementById('connection-status');
            const resultEl = document.getElementById('health-result');
            
            statusEl.innerHTML = 'ğŸ“¡ <span class="loading"></span> Äang kiá»ƒm tra káº¿t ná»‘i...';
            
            const result = await makeApiCall('/health');
            
            if (result.success) {
                statusEl.className = 'status success';
                statusEl.innerHTML = 'âœ… Káº¿t ná»‘i backend thÃ nh cÃ´ng!';
                resultEl.innerHTML = `
                    <div class="status success">
                        âœ… Backend API hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng<br>
                        ğŸ“Š Health Score: ${result.data.data?.health_score || 'N/A'}%<br>
                        ğŸ“¡ Total Modules: ${result.data.data?.total_modules || 'N/A'}<br>
                        ğŸŸ¢ Healthy: ${result.data.data?.healthy_modules || 'N/A'}<br>
                        ğŸŸ¡ Warning: ${result.data.data?.warning_modules || 'N/A'}<br>
                        ğŸ”´ Error: ${result.data.data?.error_modules || 'N/A'}
                    </div>
                `;
            } else {
                statusEl.className = 'status error';
                statusEl.innerHTML = 'âŒ KhÃ´ng thá»ƒ káº¿t ná»‘i Ä‘áº¿n backend!';
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
        
        async function testGetModules() {
            const resultEl = document.getElementById('modules-result');
            const gridEl = document.getElementById('modules-grid');
            
            resultEl.innerHTML = '<div class="loading"></div> Äang láº¥y danh sÃ¡ch modules...';
            
            const result = await makeApiCall('/modules');
            
            if (result.success && result.data.data) {
                const modules = result.data.data;
                resultEl.innerHTML = `<div class="status success">âœ… TÃ¬m tháº¥y ${modules.length} RS485 modules</div>`;
                
                // Render modules grid
                gridEl.innerHTML = modules.map(module => `
                    <div class="module-card">
                        <div class="module-header">
                            <div class="module-name">${module.name}</div>
                            <div class="module-status status-${module.status}">${module.status}</div>
                        </div>
                        <div class="module-details">
                            <div><strong>Address:</strong> ${module.addr}</div>
                            <div><strong>Type:</strong> ${module.mandatory ? 'Mandatory' : 'Optional'}</div>
                            <div><strong>Last Seen:</strong> ${module.last_seen}</div>
                            <div><strong>Error Rate:</strong> ${module.error_rate.toFixed(2)}%</div>
                            <div><strong>Response Time:</strong> ${module.response_time}ms</div>
                            <div><strong>FW Version:</strong> ${module.fw_version}</div>
                            <div><strong>Battery:</strong> ${module.real_time.battery.toFixed(1)}%</div>
                            <div><strong>Temperature:</strong> ${module.real_time.temperature.toFixed(1)}Â°C</div>
                        </div>
                    </div>
                `).join('');
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
                gridEl.innerHTML = '';
            }
        }
        
        async function testGetModule(address) {
            const resultEl = document.getElementById('modules-result');
            
            resultEl.innerHTML = `<div class="loading"></div> Äang láº¥y thÃ´ng tin module 0x${address.toString(16).padStart(2,'0').toUpperCase()}...`;
            
            const result = await makeApiCall(`/modules/${address}`);
            
            if (result.success && result.data.data) {
                const module = result.data.data;
                resultEl.innerHTML = `
                    <div class="status success">
                        âœ… Module ${module.name} (${module.addr})<br>
                        ğŸ“Š Status: ${module.status}<br>
                        ğŸ”‹ Battery: ${module.real_time.battery.toFixed(1)}%<br>
                        ğŸŒ¡ï¸ Temperature: ${module.real_time.temperature.toFixed(1)}Â°C<br>
                        âš¡ Voltage: ${module.real_time.voltage.toFixed(1)}V<br>
                        ğŸ“¡ Last Seen: ${module.last_seen}
                    </div>
                `;
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
        
        async function testBusHealth() {
            const resultEl = document.getElementById('bus-result');
            
            resultEl.innerHTML = '<div class="loading"></div> Äang kiá»ƒm tra RS485 bus health...';
            
            const result = await makeApiCall('/bus/health');
            
            if (result.success && result.data.data) {
                const bus = result.data.data;
                resultEl.innerHTML = `
                    <div class="status success">
                        âœ… RS485 Bus Health<br>
                        ğŸ“Š Status: ${bus.status}<br>
                        ğŸ“ˆ Error Rate: ${bus.error_rate.toFixed(2)}%<br>
                        â±ï¸ Response P95: ${bus.response_time_p95}ms<br>
                        ğŸš€ Throughput: ${bus.throughput} fps<br>
                        ğŸ“¡ Total Modules: ${bus.total_modules}<br>
                        ğŸŸ¢ Active: ${bus.active_modules}<br>
                        ğŸ”´ Failed: ${bus.failed_modules}
                    </div>
                `;
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
        
        async function testRestartBus() {
            if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n restart RS485 bus khÃ´ng?')) return;
            
            const resultEl = document.getElementById('bus-result');
            
            resultEl.innerHTML = '<div class="loading"></div> Äang restart RS485 bus...';
            
            const result = await makeApiCall('/bus/restart', {
                method: 'POST',
                body: JSON.stringify({ action: 'restart', force: false })
            });
            
            if (result.success) {
                resultEl.innerHTML = `<div class="status success">âœ… ${result.data.message}</div>`;
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
        
        async function testStartDiscovery() {
            const resultEl = document.getElementById('discovery-result');
            
            resultEl.innerHTML = '<div class="loading"></div> Äang báº¯t Ä‘áº§u discovery...';
            
            const result = await makeApiCall('/discovery/start', { method: 'POST' });
            
            if (result.success && result.data.data) {
                const discovery = result.data.data;
                resultEl.innerHTML = `
                    <div class="status info">
                        ğŸ” Discovery Started<br>
                        ğŸ“Š Status: ${discovery.status_message}<br>
                        ğŸ“ˆ Progress: ${discovery.progress}%<br>
                        ğŸ“¡ Modules Found: ${discovery.modules_found}
                    </div>
                `;
                
                // Auto-update status
                setTimeout(() => testDiscoveryStatus(), 2000);
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
        
        async function testDiscoveryStatus() {
            const resultEl = document.getElementById('discovery-result');
            
            const result = await makeApiCall('/discovery/status');
            
            if (result.success && result.data.data) {
                const discovery = result.data.data;
                const statusClass = discovery.is_running ? 'info' : 'success';
                resultEl.innerHTML = `
                    <div class="status ${statusClass}">
                        ğŸ” Discovery Status<br>
                        ğŸ“Š Status: ${discovery.status_message}<br>
                        ğŸ“ˆ Progress: ${discovery.progress}%<br>
                        ğŸ“¡ Modules Found: ${discovery.modules_found}<br>
                        âš ï¸ Conflicts: ${discovery.conflicts.length}
                    </div>
                `;
                
                if (discovery.is_running) {
                    setTimeout(() => testDiscoveryStatus(), 1000);
                }
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
        
        async function testDiscoveryResults() {
            const resultEl = document.getElementById('discovery-result');
            
            const result = await makeApiCall('/discovery/results');
            
            if (result.success && result.data.data) {
                const results = result.data.data;
                resultEl.innerHTML = `
                    <div class="status success">
                        âœ… Discovery Results (${results.length} modules)<br>
                        ${results.map(r => `ğŸ“¡ ${r.addr} - ${r.name} ${r.found ? 'âœ…' : 'âŒ'} ${r.conflict ? 'âš ï¸' : ''}`).join('<br>')}
                    </div>
                `;
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
        
        async function testPingModule(address) {
            const resultEl = document.getElementById('actions-result');
            
            resultEl.innerHTML = `<div class="loading"></div> Äang ping module 0x${address.toString(16).padStart(2,'0').toUpperCase()}...`;
            
            const result = await makeApiCall(`/modules/${address}/ping`, { method: 'POST' });
            
            if (result.success && result.data.data) {
                resultEl.innerHTML = `
                    <div class="status success">
                        âœ… Ping Successful<br>
                        ğŸ“¨ Message: ${result.data.data.message}<br>
                        â±ï¸ Response Time: ${result.data.data.response_time}ms
                    </div>
                `;
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
        
        async function testResetModule(address) {
            if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n reset module 0x${address.toString(16).padStart(2,'0').toUpperCase()} khÃ´ng?`)) return;
            
            const resultEl = document.getElementById('actions-result');
            
            resultEl.innerHTML = `<div class="loading"></div> Äang reset module 0x${address.toString(16).padStart(2,'0').toUpperCase()}...`;
            
            const result = await makeApiCall(`/modules/${address}/reset`, { method: 'POST' });
            
            if (result.success) {
                resultEl.innerHTML = `<div class="status success">âœ… ${result.data.message}</div>`;
            } else {
                resultEl.innerHTML = `<div class="status error">âŒ ${result.error}</div>`;
            }
        }
    </script>
</body>
</html>
