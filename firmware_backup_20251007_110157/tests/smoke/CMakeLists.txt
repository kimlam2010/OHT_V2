# Smoke tests for Minimal API v1 using ctest + curl
find_program(CURL_BIN curl)
if(NOT CURL_BIN)
  message(WARNING "curl not found; smoke tests will be disabled")
  return()
endif()
set(SMOKE_HOST "127.0.0.1" CACHE STRING "Smoke test host")
set(SMOKE_PORT "8080" CACHE STRING "Smoke test port")
function(add_smoke name path method)
  if(method STREQUAL "GET")
    add_test(NAME smoke_${name}
      COMMAND ${CURL_BIN} -sS --max-time 3 http://${SMOKE_HOST}:${SMOKE_PORT}${path})
  else()
    add_test(NAME smoke_${name}
      COMMAND ${CURL_BIN} -sS --max-time 3 -X ${method} http://${SMOKE_HOST}:${SMOKE_PORT}${path})
  endif()
endfunction()
add_smoke(system_status "/api/v1/system/status" GET)
add_smoke(safety_status "/api/v1/safety/status" GET)
add_smoke(safety_estop "/api/v1/safety/estop" POST)
add_smoke(modules_list "/api/v1/modules" GET)
add_smoke(module_status_by_id "/api/v1/modules/1/status" GET)
add_smoke(system_state "/api/v1/system/state" GET)
add_smoke(control_status "/api/v1/control/status" GET)
set_tests_properties(smoke_system_status PROPERTIES PASS_REGULAR_EXPRESSION "\\{.*\\}")
set_tests_properties(smoke_safety_status PROPERTIES PASS_REGULAR_EXPRESSION "\\{.*\\}")
set_tests_properties(smoke_safety_estop PROPERTIES PASS_REGULAR_EXPRESSION "\\{.*\\}")
set_tests_properties(smoke_modules_list PROPERTIES PASS_REGULAR_EXPRESSION "\\{.*\\}")
set_tests_properties(smoke_module_status_by_id PROPERTIES PASS_REGULAR_EXPRESSION "\\{.*\\}")
set_tests_properties(smoke_system_state PROPERTIES PASS_REGULAR_EXPRESSION "\\{.*\\}")
set_tests_properties(smoke_control_status PROPERTIES PASS_REGULAR_EXPRESSION "\\{.*\\}")
